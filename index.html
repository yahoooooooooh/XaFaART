<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ åŠ©æ‰‹ - è‰ºæœ¯å²ä¸ä¸–ç•Œå¸¸è¯†</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Admin Toggle Button -->
    <button class="admin-toggle" id="adminToggle" title="ç®¡ç†é¢˜åº“">âš™ï¸</button>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <h3>ğŸ“š é¢˜åº“ç®¡ç†</h3>
        
        <form class="admin-form" id="addQuizForm">
            <label>å­¦ç§‘åˆ†ç±»</label>
            <select id="subjectSelect" required>
                <option value="">è¯·é€‰æ‹©å­¦ç§‘</option>
                <option value="western_art">è¥¿æ–¹è‰ºæœ¯å²</option>
                <option value="chinese_art">ä¸­å›½ç¾æœ¯å²</option>
                <option value="art_theory">è‰ºæœ¯æ¦‚è®º</option>
                <option value="world_knowledge">ä¸–ç•Œå¸¸è¯†</option>
            </select>

            <label>æ—¶æœŸåˆ†ç±»</label>
            <select id="periodSelect" required>
                <option value="">è¯·å…ˆé€‰æ‹©å­¦ç§‘</option>
            </select>
            <input type="text" id="customPeriodInput" placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰åˆ†ç±»åç§°" style="margin-top: 8px;">

            <label>é¢˜åº“åç§°</label>
            <input type="text" id="quizNameInput" placeholder="å¦‚ï¼šå°è±¡æ´¾åˆçº§é¢˜åº“ã€æ–‡å²åŸºç¡€100é¢˜" required>

            <label>é¢˜åº“æè¿°</label>
            <textarea id="quizDescInput" placeholder="ç®€è¦æè¿°è¿™ä¸ªé¢˜åº“çš„å†…å®¹" rows="3"></textarea>

            <label>éš¾åº¦ç­‰çº§</label>
            <select id="difficultySelect" required>
                <option value="easy">åˆçº§</option>
                <option value="medium">ä¸­çº§</option>
                <option value="hard">é«˜çº§</option>
            </select>

            <label>é¢„è®¡ç”¨æ—¶</label>
            <input type="text" id="estimatedTimeInput" placeholder="å¦‚ï¼š15-20åˆ†é’Ÿ" required>

            <button type="submit">âœ… æ·»åŠ é¢˜åº“</button>
        </form>

        <!-- æ•°æ®å¤‡ä»½ç®¡ç†åŒºåŸŸ -->
        <div class="backup-section">
            <h4>ğŸ’¾ æ•°æ®å¤‡ä»½ç®¡ç†</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button type="button" id="backupDataBtn" style="background: #805ad5; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; cursor: pointer; font-weight: 500;">
                    ğŸ“¦ å¤‡ä»½æ•°æ®
                </button>
                <button type="button" id="restoreDataBtn" style="background: #38a169; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; cursor: pointer; font-weight: 500;">
                    ğŸ“‚ æ¢å¤æ•°æ®
                </button>
            </div>
            <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
            <div style="font-size: 0.85em; color: var(--text-muted); line-height: 1.4;">
                ğŸ’¡ <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                â€¢ å¤‡ä»½ï¼šä¸‹è½½å½“å‰æ‰€æœ‰é¢˜åº“æ•°æ®åˆ°æœ¬åœ°JSONæ–‡ä»¶<br>
                â€¢ æ¢å¤ï¼šé€‰æ‹©å¤‡ä»½çš„JSONæ–‡ä»¶æ¥æ¢å¤é¢˜åº“æ•°æ®<br>
                â€¢ å»ºè®®å®šæœŸå¤‡ä»½ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
            </div>
        </div>

        <div class="quiz-data-editor">
            <h4>ğŸ“ é¢˜ç›®æ•°æ®</h4>
            <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                <p style="font-size: 0.9em; color: var(--text-muted); margin: 0; flex: 1;">
                    åœ¨ä¸‹æ–¹ç²˜è´´é¢˜ç›®æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰ï¼Œç‚¹å‡»"æ·»åŠ é¢˜åº“"æ—¶ä¼šè‡ªåŠ¨è¯»å–
                </p>
                <button type="button" id="copyInstructionBtn" style="background: #3182ce; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8em; cursor: pointer; white-space: nowrap;">
                    ğŸ“„ è·å–AIç”ŸæˆæŒ‡ä»¤
                </button>
            </div>
            <textarea id="quizDataInput" placeholder='ç‚¹å‡»ä¸Šæ–¹"ğŸ“„ è·å–AIç”ŸæˆæŒ‡ä»¤"æŒ‰é’®è·å–å®Œæ•´çš„é¢˜ç›®ç”ŸæˆæŒ‡ä»¤ï¼ˆåŒ…å«JSONæ ¼å¼ç¤ºä¾‹ï¼‰'></textarea>
        </div>

        <div class="quiz-list" id="quizList">
            <h4>ğŸ“‹ ç°æœ‰é¢˜åº“</h4>
            <div id="quizListContent">
                <!-- é¢˜åº“åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <h1>å­¦ä¹ åŠ©æ‰‹</h1>
            <p>æ¢ç´¢è‰ºæœ¯çš„æ— ç©·é­…åŠ›ä¸ä¸–ç•Œå¸¸è¯†ï¼Œä»ç»å…¸åˆ°ç°ä»£ï¼Œå¼€å¯æ‚¨çš„å…¨é¢å­¦ä¹ ä¹‹æ—…</p>
        </header>

        <!-- Navigation Breadcrumb -->
        <nav class="breadcrumb" id="breadcrumb">
            <div class="breadcrumb-item current" data-level="home">
                ğŸ  é¦–é¡µ
            </div>
        </nav>

        <main class="main-content">
            <div class="cards-grid" id="cardsGrid">
                <!-- Content will be dynamically generated -->
            </div>
        </main>
    </div>

    <!-- Quiz Container (å†…åµŒé¢˜åº“å¼•æ“) -->
    <div class="quiz-container embedded" id="quizContainer">
        <div class="quiz-wrapper">
            <header class="quiz-header">
                <button class="quiz-close-btn" id="quizCloseBtn">Ã—</button>
                <h1 id="quizTitle">é¢˜åº“æ ‡é¢˜</h1>
                <p id="quizSubtitle">é¢˜åº“æè¿°</p>
            </header>

            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>

            <div class="quiz-content-area" id="quizContentArea">
                <div id="quiz-area">
                    <!-- Single question will be displayed here -->
                </div>
            </div>
            
            <div class="final-score-container" id="finalScoreContainer">
                <div id="finalScoreSummary" class="final-score-summary">
                    <!-- Final score will be shown here -->
                </div>
                <div class="final-score-actions">
                    <button id="review-incorrect-btn" class="nav-btn">
                        ğŸ” å›é¡¾é”™é¢˜
                    </button>
                    <button id="restart-btn" class="nav-btn">
                        ğŸ”„ é‡æ–°å¼€å§‹
                    </button>
                </div>
            </div>

            <div class="navigation-controls" id="navigationControls">
                <div class="navigation-buttons">
                    <button id="prev-btn" class="nav-btn">
                        â† ä¸Šä¸€é¢˜
                    </button>
                    <button id="submit-btn" class="submit-btn-single nav-btn">
                        æäº¤ç­”æ¡ˆ âœ“
                    </button>
                    <button id="next-btn" class="nav-btn">
                        ä¸‹ä¸€é¢˜ â†’
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load JavaScript modules in correct order -->
    <script>
        // ===== DATA MODULE =====
        // é¢„å®šä¹‰çš„æ—¶æœŸåˆ†ç±»é€‰é¡¹
        const periodOptions = {
            western_art: [
                { id: 'ancient', name: 'å¤å…¸æ—¶æœŸ', description: 'å¤å¸Œè…Šç½—é©¬è‰ºæœ¯' },
                { id: 'medieval', name: 'ä¸­ä¸–çºª', description: 'æ‹œå åº­ä¸å“¥ç‰¹å¼è‰ºæœ¯' },
                { id: 'renaissance', name: 'æ–‡è‰ºå¤å…´', description: '15-16ä¸–çºªæ¬§æ´²è‰ºæœ¯å¤å…´' },
                { id: 'baroque', name: 'å·´æ´›å…‹', description: '17-18ä¸–çºªå·´æ´›å…‹è‰ºæœ¯' },
                { id: 'neoclassicism', name: 'æ–°å¤å…¸ä¸»ä¹‰', description: '18-19ä¸–çºªæ–°å¤å…¸è‰ºæœ¯' },
                { id: 'romanticism', name: 'æµªæ¼«ä¸»ä¹‰', description: '18-19ä¸–çºªæµªæ¼«ä¸»ä¹‰è‰ºæœ¯' },
                { id: 'impressionism', name: 'å°è±¡æ´¾', description: '19ä¸–çºªæ³•å›½å°è±¡æ´¾è‰ºæœ¯è¿åŠ¨' },
                { id: 'post_impressionism', name: 'åå°è±¡æ´¾', description: '19ä¸–çºªæœ«åå°è±¡æ´¾è‰ºæœ¯' },
                { id: 'modernism', name: 'ç°ä»£ä¸»ä¹‰', description: '20ä¸–çºªç°ä»£è‰ºæœ¯è¿åŠ¨' },
                { id: 'contemporary', name: 'å½“ä»£è‰ºæœ¯', description: '20ä¸–çºªåæœŸè‡³ä»Šçš„è‰ºæœ¯' }
            ],
            chinese_art: [
                { id: 'ancient', name: 'å…ˆç§¦æ—¶æœŸ', description: 'å•†å‘¨é’é“œå™¨ä¸æ—©æœŸç»˜ç”»' },
                { id: 'han', name: 'æ±‰ä»£', description: 'æ±‰ä»£è‰ºæœ¯ä¸ä¸ç»¸ä¹‹è·¯' },
                { id: 'tang', name: 'å”ä»£', description: 'ç››å”è‰ºæœ¯ä¸å›½é™…äº¤æµ' },
                { id: 'song', name: 'å®‹ä»£', description: 'å®‹ä»£ç»˜ç”»ä¸ä¹¦æ³•' },
                { id: 'yuan', name: 'å…ƒä»£', description: 'å…ƒä»£æ–‡äººç”»' },
                { id: 'ming', name: 'æ˜ä»£', description: 'æ˜ä»£å®«å»·ä¸æ°‘é—´è‰ºæœ¯' },
                { id: 'qing', name: 'æ¸…ä»£', description: 'æ¸…ä»£è‰ºæœ¯ä¸è¥¿æ–¹å½±å“' },
                { id: 'modern', name: 'è¿‘ç°ä»£', description: '19-20ä¸–çºªä¸­å›½è‰ºæœ¯å˜é©' },
                { id: 'contemporary', name: 'å½“ä»£', description: 'æ”¹é©å¼€æ”¾ä»¥æ¥çš„ä¸­å›½è‰ºæœ¯' }
            ],
            art_theory: [
                { id: 'aesthetics', name: 'ç¾å­¦ç†è®º', description: 'è‰ºæœ¯ç¾å­¦åŸºç¡€ç†è®º' },
                { id: 'art_history', name: 'è‰ºæœ¯å²å­¦', description: 'è‰ºæœ¯å²ç ”ç©¶æ–¹æ³•' },
                { id: 'criticism', name: 'è‰ºæœ¯æ‰¹è¯„', description: 'è‰ºæœ¯æ‰¹è¯„ç†è®ºä¸å®è·µ' },
                { id: 'psychology', name: 'è‰ºæœ¯å¿ƒç†å­¦', description: 'è‰ºæœ¯åˆ›ä½œä¸æ¬£èµå¿ƒç†' },
                { id: 'sociology', name: 'è‰ºæœ¯ç¤¾ä¼šå­¦', description: 'è‰ºæœ¯ä¸ç¤¾ä¼šå…³ç³»' },
                { id: 'media', name: 'åª’ä»‹ç†è®º', description: 'è‰ºæœ¯åª’ä»‹ä¸æŠ€æœ¯' }
            ],
            world_knowledge: [
                { id: 'liberal_arts', name: 'æ–‡å²å“²ç»¼åˆ', description: 'æ–‡å­¦ã€å†å²ã€å“²å­¦ç­‰äººæ–‡å­¦ç§‘åŸºç¡€å¸¸è¯†' },
                { id: 'law_politics', name: 'æ³•æ”¿å¸¸è¯†', description: 'æ³•å¾‹æ³•è§„ã€æ”¿æ²»åˆ¶åº¦ã€æ—¶äº‹æ”¿ç­–ç­‰åŸºç¡€çŸ¥è¯†' },
                { id: 'science_math', name: 'ç†ç§‘ç»¼åˆ', description: 'æ•°å­¦ã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ç­‰è‡ªç„¶ç§‘å­¦åŸºç¡€' },
                { id: 'engineering_tech', name: 'å·¥ç§‘æŠ€æœ¯', description: 'å·¥ç¨‹æŠ€æœ¯ã€è®¡ç®—æœºç§‘å­¦ã€ä¿¡æ¯æŠ€æœ¯ç­‰åº”ç”¨çŸ¥è¯†' },
                { id: 'agriculture', name: 'å†œä¸šç§‘å­¦', description: 'å†œä¸šæŠ€æœ¯ã€ç”Ÿæ€ç¯å¢ƒã€é£Ÿå“å®‰å…¨ç­‰ç›¸å…³çŸ¥è¯†' },
                { id: 'medicine_health', name: 'åŒ»å­¦å¥åº·', description: 'åŸºç¡€åŒ»å­¦ã€å¥åº·å¸¸è¯†ã€ç–¾ç—…é¢„é˜²ç­‰åŒ»ç–—çŸ¥è¯†' },
                { id: 'general_culture', name: 'æ–‡åŒ–è‰ºæœ¯', description: 'æ–‡åŒ–å¸¸è¯†ã€è‰ºæœ¯é‰´èµã€ç¤¾ä¼šç”Ÿæ´»ç­‰ç»¼åˆçŸ¥è¯†' },
                { id: 'geography', name: 'åœ°ç†å¸¸è¯†', description: 'ä¸–ç•Œåœ°ç†ã€ä¸­å›½åœ°ç†ã€è‡ªç„¶åœ°ç†ç­‰çŸ¥è¯†' },
                { id: 'economics', name: 'ç»æµå­¦åŸºç¡€', description: 'åŸºç¡€ç»æµå­¦åŸç†ã€å¸‚åœºç»æµã€é‡‘èå¸¸è¯†' }
            ]
        };

        // é¢˜åº“æ•°æ®å­˜å‚¨
        // é»˜è®¤çš„ quizData ç»“æ„ï¼Œç¡®ä¿æ‰€æœ‰å­¦ç§‘éƒ½åŒ…å«åœ¨å†…
        const defaultInitialQuizData = {
            "western_art": {
                id: "western_art",
                name: "è¥¿æ–¹è‰ºæœ¯å²",
                description: "æ¢ç´¢ä»å¤è‡³ä»Šçš„è¥¿æ–¹è‰ºæœ¯å‘å±•è„‰ç»œï¼Œä»å¤å…¸ä¸»ä¹‰åˆ°ç°ä»£ä¸»ä¹‰çš„è‰ºæœ¯é©å‘½",
                icon: "ğŸ¨",
                periods: {
                    "impressionism": { // é»˜è®¤çš„ç¤ºä¾‹æ•°æ®
                        id: "impressionism",
                        name: "å°è±¡æ´¾",
                        description: "19ä¸–çºªæ³•å›½å°è±¡æ´¾è‰ºæœ¯è¿åŠ¨ï¼Œå…‰ä¸è‰²å½©çš„é©å‘½",
                        icon: "ğŸŒ…",
                        quizzes: [
                            {
                                id: "impressionism_beginner",
                                name: "å°è±¡æ´¾åˆçº§é¢˜åº“",
                                description: "é€‚åˆåˆå­¦è€…çš„å°è±¡æ´¾åŸºç¡€çŸ¥è¯†æµ‹è¯•",
                                difficulty: "easy",
                                estimatedTime: "15-20åˆ†é’Ÿ",
                                questions: [
                                    {
                                        section: "å¼•è¨€ï¼šå®šä¹‰å°è±¡æ´¾åŠå…¶é©å‘½æ€§å½±å“",
                                        question: "å°è±¡æ´¾çš„æ ¸å¿ƒä¸»å¼ åœ¨äºæ•æ‰è‰ºæœ¯å®¶å¯¹ç‰¹å®šåœºæ™¯çš„ä»€ä¹ˆï¼Ÿ",
                                        options: [
                                            "å¯¹è±¡çš„ç²¾ç»†ã€å®¢è§‚å†ç°ä¸å†å²ç»†èŠ‚",
                                            "ç¬é—´æ„Ÿå®˜å°è±¡ï¼Œå°¤å…¶æ˜¯å…‰çº¿ä¸è‰²å½©çš„å˜å¹»",
                                            "ç†æƒ³åŒ–çš„ç¾å­¦å½¢æ€ä¸ç¥è¯å™äº‹",
                                            "æ·±åˆ»çš„ç¤¾ä¼šæ‰¹åˆ¤ä¸æ”¿æ²»å¯“æ„"
                                        ],
                                        correctAnswer: 1,
                                        explanation: "å°è±¡æ´¾çš„æ ¸å¿ƒä¸»å¼ åœ¨äºæ•æ‰è‰ºæœ¯å®¶å¯¹ç‰¹å®šåœºæ™¯çš„ç¬é—´æ„Ÿå®˜å°è±¡ï¼Œè€Œéè¿½æ±‚å¯¹è±¡çš„ç²¾ç»†ã€å®¢è§‚å†ç°ã€‚å…¶è‰ºæœ¯å®è·µçš„æ ¸å¿ƒåœ¨äºå¯¹å…‰çº¿ã€è‰²å½©ä»¥åŠå˜å¹»è«æµ‹çš„ç¬é—´çš„ç²¾å¦™è¿ç”¨ã€‚"
                                    },
                                    {
                                        section: "å¼•è¨€ï¼šå®šä¹‰å°è±¡æ´¾åŠå…¶é©å‘½æ€§å½±å“",
                                        question: "\"å°è±¡æ´¾\"è¿™ä¸€åç§°æœ€åˆæºäºä»€ä¹ˆï¼Ÿ",
                                        options: [
                                            "è‰ºæœ¯å®¶ä»¬å¯¹è‡ªå·±é£æ ¼çš„ç²¾å‡†å®šä¹‰",
                                            "è‰ºæœ¯è¯„è®ºå®¶è·¯æ˜“Â·å‹’é²ç“¦å¯¹è«å¥ˆä½œå“çš„è®¥è®½æ€§è¯„è®º",
                                            "æ³•å›½ç¾æœ¯å­¦é™¢å¯¹æ–°å…´ç”»æ´¾çš„å®˜æ–¹å‘½å",
                                            "è§‚ä¼—å¯¹ç”»å±•çš„æ™®éæ­£é¢è¯„ä»·"
                                        ],
                                        correctAnswer: 1,
                                        explanation: "\"å°è±¡æ´¾\"è¿™ä¸€åç§°æºäºè‰ºæœ¯è¯„è®ºå®¶è·¯æ˜“Â·å‹’é²ç“¦å¯¹1874å¹´é¦–å±Šå°è±¡æ´¾ç”»å±•çš„è®¥è®½æ€§è¯„è®ºï¼Œç‰¹æ„é’ˆå¯¹å…‹æ´›å¾·Â·è«å¥ˆçš„ä½œå“ã€Šå°è±¡Â·æ—¥å‡ºã€‹è¿›è¡ŒæŒ–è‹¦ã€‚"
                                    }
                                ]
                            }
                        ]
                    }
                }
            },
            "chinese_art": {
                id: "chinese_art",
                name: "ä¸­å›½ç¾æœ¯å²",
                description: "é¢†ç•¥åšå¤§ç²¾æ·±çš„ä¸­åè‰ºæœ¯ç‘°å®ï¼Œä»å¤ä»£åˆ°è¿‘ç°ä»£çš„è‰ºæœ¯ä¼ æ‰¿",
                icon: "ğŸ–Œï¸",
                periods: {} // åˆå§‹ä¸ºç©º
            },
            "art_theory": {
                id: "art_theory",
                name: "è‰ºæœ¯æ¦‚è®º",
                description: "è‰ºæœ¯çš„æœ¬è´¨ã€åŠŸèƒ½ä¸å®¡ç¾ç†è®ºï¼Œå»ºç«‹ç³»ç»Ÿçš„è‰ºæœ¯è®¤çŸ¥æ¡†æ¶",
                icon: "ğŸ“š",
                periods: {} // åˆå§‹ä¸ºç©º
            },
            "world_knowledge": { // ç¡®ä¿ world_knowledge åœ¨é»˜è®¤ç»“æ„ä¸­
                id: "world_knowledge",
                name: "ä¸–ç•Œå¸¸è¯†",
                description: "æ¶µç›–æ–‡ã€æ³•ã€ç†ã€å·¥ã€å†œã€åŒ»ã€è‰ºç­‰å„é¢†åŸŸçš„åŸºç¡€å¸¸è¯†ä¸æ ¸å¿ƒçŸ¥è¯†",
                icon: "ğŸŒ",
                periods: { // é»˜è®¤çš„ç¤ºä¾‹æ•°æ®
                    "liberal_arts": {
                        id: "liberal_arts",
                        name: "æ–‡å²å“²ç»¼åˆ",
                        description: "æ–‡å­¦ã€å†å²ã€å“²å­¦ç­‰äººæ–‡å­¦ç§‘çš„åŸºç¡€å¸¸è¯†",
                        icon: "ğŸ“œ",
                        quizzes: []
                    }
                }
            }
        };
        
        // æ·±æ‹·è´é»˜è®¤æ•°æ®ï¼Œé¿å…ç›´æ¥ä¿®æ”¹ defaultInitialQuizData
        let quizData = JSON.parse(localStorage.getItem('artQuizData')) || JSON.parse(JSON.stringify(defaultInitialQuizData));


        // æ•°æ®ç®¡ç†å™¨
        const DataManager = {
            getData() {
                return quizData;
            },

            saveData() {
                localStorage.setItem('artQuizData', JSON.stringify(quizData));
            },

            getPeriodOptions(subjectId) {
                return periodOptions[subjectId] || [];
            },

            addQuiz(subjectId, periodData, newQuizData) { // changed quizData to newQuizData to avoid conflict
                const subject = this.getData()[subjectId];
                if (!subject) {
                    throw new Error('æ‰€é€‰å­¦ç§‘ä¸å­˜åœ¨');
                }

                if (!subject.periods[periodData.id]) {
                    subject.periods[periodData.id] = {
                        id: periodData.id,
                        name: periodData.name,
                        description: periodData.description,
                        icon: this.getRandomIcon(),
                        quizzes: []
                    };
                }

                subject.periods[periodData.id].quizzes.push(newQuizData);
                this.saveData();
            },

            deleteQuiz(subjectId, periodId, quizId) {
                const period = this.getData()[subjectId]?.periods[periodId];
                if (!period) return false;

                period.quizzes = period.quizzes.filter(quiz => quiz.id !== quizId);

                if (period.quizzes.length === 0) {
                    delete this.getData()[subjectId].periods[periodId];
                }

                this.saveData();
                return true;
            },

            getQuiz(subjectId, periodId, quizId) {
                return this.getData()[subjectId]?.periods[periodId]?.quizzes.find(q => q.id === quizId);
            },

            getRandomIcon() {
                const icons = ['ğŸ­', 'ğŸ–¼ï¸', 'ğŸ›ï¸', 'ğŸŒ¸', 'ğŸº', 'ğŸ“œ', 'ğŸª', 'ğŸ¨', 'ğŸ–Œï¸', 'âœ¨', 'ğŸ’¡', 'â­', 'ğŸ”¥', 'ğŸŒŸ'];
                return icons[Math.floor(Math.random() * icons.length)];
            },

            validateQuizData(data) {
                try {
                    if (!data || typeof data !== 'object') return false;

                    for (const [subjectId, subject] of Object.entries(data)) {
                        if (!subject.id || !subject.name || !subject.periods) return false;
                        
                        for (const [periodId, period] of Object.entries(subject.periods)) {
                            if (!period.id || !period.name || !Array.isArray(period.quizzes)) return false;
                            
                            for (const quiz of period.quizzes) {
                                if (!quiz.id || !quiz.name || !Array.isArray(quiz.questions)) return false;
                                
                                for (const question of quiz.questions) {
                                    if (!question.question || !question.options || 
                                        !Array.isArray(question.options) || 
                                        question.options.length !== 4 || // Or check for options.length >= 2 if you allow more/less
                                        typeof question.correctAnswer !== 'number' ||
                                        question.correctAnswer < 0 || question.correctAnswer >= question.options.length) { // correctAnswer should be within options bounds
                                        console.error("Invalid question structure:", question, "in quiz:", quiz.name);
                                        return false;
                                    }
                                }
                            }
                        }
                    }
                    return true;
                } catch (error) {
                    console.error('æ•°æ®éªŒè¯é”™è¯¯:', error);
                    return false;
                }
            },

            getDataStatistics(data = null) {
                const sourceData = data || this.getData();
                let subjects = 0;
                let periods = 0;
                let quizzes = 0;
                let questions = 0;

                for (const subject of Object.values(sourceData)) {
                    subjects++;
                    if (subject.periods && typeof subject.periods === 'object') {
                        for (const period of Object.values(subject.periods)) {
                            periods++;
                            if (period.quizzes && Array.isArray(period.quizzes)) {
                                for (const quiz of period.quizzes) {
                                    quizzes++;
                                    if (quiz.questions && Array.isArray(quiz.questions)) {
                                        questions += quiz.questions.length;
                                    }
                                }
                            }
                        }
                    }
                }
                return { subjects, periods, quizzes, questions };
            },

            restoreData(newData) {
                if (!this.validateQuizData(newData)) {
                    throw new Error('æ•°æ®æ ¼å¼éªŒè¯å¤±è´¥');
                }
                quizData = newData; // Directly assign validated new data
                this.saveData();
            },

            getBackupData() {
                const now = new Date();
                return {
                    version: "1.0",
                    exportTime: now.toISOString(),
                    totalQuizzes: this.getDataStatistics().quizzes,
                    data: this.getData()
                };
            }
        };

        // ç¡®ä¿æ•°æ®ç»“æ„å®Œæ•´ (MODIFIED IIFE)
        (function initializeData() {
            let dataWasModified = false;
            // Use the same defaultInitialQuizData for consistency in structure
            const defaultStructure = JSON.parse(JSON.stringify(defaultInitialQuizData));

            // 1. æ£€æŸ¥å¹¶ä¿®å¤é¡¶å±‚å­¦ç§‘å¯¹è±¡
            for (const subjectKey in defaultStructure) {
                if (!quizData.hasOwnProperty(subjectKey) || typeof quizData[subjectKey] !== 'object' || quizData[subjectKey] === null) {
                    console.warn(`Subject key "${subjectKey}" missing or invalid in loaded quizData. Initializing with default structure.`);
                    quizData[subjectKey] = JSON.parse(JSON.stringify(defaultStructure[subjectKey]));
                    dataWasModified = true;
                } else {
                    // ç¡®ä¿åŸºæœ¬å±æ€§å­˜åœ¨
                    if (!quizData[subjectKey].id) { quizData[subjectKey].id = defaultStructure[subjectKey].id; dataWasModified = true; }
                    if (!quizData[subjectKey].name) { quizData[subjectKey].name = defaultStructure[subjectKey].name; dataWasModified = true; }
                    if (!quizData[subjectKey].description) { quizData[subjectKey].description = defaultStructure[subjectKey].description; dataWasModified = true; }
                    if (!quizData[subjectKey].icon) { quizData[subjectKey].icon = defaultStructure[subjectKey].icon; dataWasModified = true; }

                    // å¦‚æœå­¦ç§‘å­˜åœ¨ï¼Œä½†ç¼ºå°‘ periods å¯¹è±¡ï¼Œåˆ™æ·»åŠ 
                    if (typeof quizData[subjectKey].periods !== 'object' || quizData[subjectKey].periods === null) {
                        console.warn(`Periods object missing for subject "${subjectKey}". Initializing.`);
                        quizData[subjectKey].periods = JSON.parse(JSON.stringify(defaultStructure[subjectKey].periods)) || {};
                        dataWasModified = true;
                    } else {
                        // å¦‚æœ periods å¯¹è±¡å­˜åœ¨ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ£€æŸ¥å…¶ä¸­çš„é»˜è®¤æ—¶æœŸ
                        for (const periodKey in defaultStructure[subjectKey].periods) {
                            if (!quizData[subjectKey].periods.hasOwnProperty(periodKey) || 
                                typeof quizData[subjectKey].periods[periodKey] !== 'object' ||
                                quizData[subjectKey].periods[periodKey] === null) {
                                console.warn(`Default period "${periodKey}" missing in subject "${subjectKey}". Initializing.`);
                                quizData[subjectKey].periods[periodKey] = JSON.parse(JSON.stringify(defaultStructure[subjectKey].periods[periodKey]));
                                dataWasModified = true;
                            } else {
                                // ç¡®ä¿é»˜è®¤æ—¶æœŸçš„åŸºæœ¬å±æ€§
                                const defaultPeriod = defaultStructure[subjectKey].periods[periodKey];
                                const currentPeriod = quizData[subjectKey].periods[periodKey];
                                if (!currentPeriod.id) { currentPeriod.id = defaultPeriod.id; dataWasModified = true; }
                                if (!currentPeriod.name) { currentPeriod.name = defaultPeriod.name; dataWasModified = true; }
                                if (!currentPeriod.description) { currentPeriod.description = defaultPeriod.description; dataWasModified = true; }
                                if (!currentPeriod.icon) { currentPeriod.icon = defaultPeriod.icon; dataWasModified = true; }
                                if (!Array.isArray(currentPeriod.quizzes)) { currentPeriod.quizzes = []; dataWasModified = true; }
                            }
                        }
                    }
                }
            }

            if (dataWasModified) {
                console.log("QuizData was modified during initialization to ensure structural integrity. Saving to localStorage.");
                DataManager.saveData();
            } else {
                console.log("QuizData loaded from localStorage is structurally sound or default data used.");
            }
        })();
    </script>
    
    <script>
        // ===== QUIZ ENGINE =====
        class QuizEngine {
            constructor() {
                this.currentQuizData = null;
                this.currentQuestionIndex = 0;
                this.userAnswers = [];
                this.answeredStatus = [];
                this.score = 0;
                this.incorrectQuestions = [];
                this.currentIncorrectReviewIndex = 0;
                this.quizStartTime = null;
                this.quizEndTime = null;
                this.isReviewMode = false;
                
                this.initElements();
                this.setupEventListeners();
            }

            initElements() {
                this.quizContainer = document.getElementById('quizContainer');
                this.quizTitle = document.getElementById('quizTitle');
                this.quizSubtitle = document.getElementById('quizSubtitle');
                this.quizContentArea = document.getElementById('quizContentArea');
                this.quizArea = document.getElementById('quiz-area');
                this.finalScoreContainer = document.getElementById('finalScoreContainer');
                this.finalScoreSummaryDiv = document.getElementById('finalScoreSummary');
                this.progressBarContainer = document.getElementById('progressBarContainer');
                this.progressBar = document.getElementById('progressBar');
                this.prevBtn = document.getElementById('prev-btn');
                this.nextBtn = document.getElementById('next-btn');
                this.submitBtn = document.getElementById('submit-btn');
                this.restartBtn = document.getElementById('restart-btn');
                this.reviewIncorrectBtn = document.getElementById('review-incorrect-btn');
                this.navigationControls = document.getElementById('navigationControls');
                this.quizCloseBtn = document.getElementById('quizCloseBtn');
            }

            setupEventListeners() {
                this.prevBtn.addEventListener('click', () => this.handlePrevious());
                this.nextBtn.addEventListener('click', () => this.handleNext());
                this.submitBtn.addEventListener('click', () => this.handleSubmit());
                this.restartBtn.addEventListener('click', () => this.restart());
                this.reviewIncorrectBtn.addEventListener('click', () => this.startReviewIncorrect());
                this.quizCloseBtn.addEventListener('click', () => this.close());
            }

            start(subjectId, periodId, quizId) {
                const quiz = DataManager.getQuiz(subjectId, periodId, quizId);
                if (!quiz || !quiz.questions || quiz.questions.length === 0) {
                    alert('é¢˜åº“æ•°æ®é”™è¯¯æˆ–ä¸ºç©ºï¼');
                    return;
                }

                this.currentQuizData = quiz.questions;
                this.quizTitle.textContent = quiz.name;
                this.quizSubtitle.textContent = quiz.description;

                this.init();
                this.show();
            }

            init() {
                this.currentQuestionIndex = 0;
                this.userAnswers = new Array(this.currentQuizData.length).fill(null);
                this.answeredStatus = new Array(this.currentQuizData.length).fill(false);
                this.score = 0;
                this.incorrectQuestions = [];
                this.isReviewMode = false;
                this.quizStartTime = new Date();
                
                this.quizContentArea.style.display = 'block';
                this.navigationControls.style.display = 'block';
                this.progressBarContainer.style.display = 'block';
                this.finalScoreContainer.style.display = 'none';
                
                this.displayQuestion(this.currentQuestionIndex);
            }

            show() {
                this.quizContainer.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            close() {
                this.quizContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
                this.reset();
            }

            reset() {
                this.currentQuizData = null;
                this.currentQuestionIndex = 0;
                this.userAnswers = [];
                this.answeredStatus = [];
                this.score = 0;
                this.incorrectQuestions = [];
                this.isReviewMode = false;
            }

            displayQuestion(index, isReview = false) {
                this.isReviewMode = isReview;
                const questionData = this.currentQuizData[index];
                this.quizArea.innerHTML = '';

                const questionBlock = this.createQuestionBlock(questionData, index, isReview);
                this.quizArea.appendChild(questionBlock);
                
                this.updateNavigationButtons();
                if (!isReview) this.updateProgressBar();
                
                this.submitBtn.style.display = isReview ? 'none' : 'inline-flex';
                if (!isReview) {
                    this.submitBtn.disabled = this.answeredStatus[index] || this.userAnswers[index] === null;
                }

                this.quizContentArea.scrollTop = 0;
            }

            createQuestionBlock(questionData, index, isReview) {
                const questionBlock = document.createElement('div');
                questionBlock.classList.add('question-block');

                const questionHeader = document.createElement('div');
                questionHeader.classList.add('question-header');
                
                const sectionTitleDisplay = document.createElement('span');
                sectionTitleDisplay.classList.add('section-title-display');
                sectionTitleDisplay.textContent = questionData.section || "ç»¼åˆ"; // Default section if not provided
                questionHeader.appendChild(sectionTitleDisplay);

                const questionNumberDisplay = document.createElement('span');
                questionNumberDisplay.classList.add('question-number-display');
                if (isReview) {
                    questionNumberDisplay.textContent = `é”™é¢˜ ${this.currentIncorrectReviewIndex + 1} / ${this.incorrectQuestions.length}`;
                } else {
                    questionNumberDisplay.textContent = `é¢˜ç›® ${index + 1} / ${this.currentQuizData.length}`;
                }
                questionHeader.appendChild(questionNumberDisplay);
                
                questionBlock.appendChild(questionHeader);

                const questionText = document.createElement('p');
                questionText.classList.add('question-text');
                questionText.innerHTML = questionData.question;
                questionBlock.appendChild(questionText);

                const optionsDiv = this.createOptionsDiv(questionData, index, isReview);
                questionBlock.appendChild(optionsDiv);

                if ((!isReview && this.answeredStatus[index]) || isReview) {
                    const explanationDiv = this.createExplanationDiv(questionData, index, isReview);
                    questionBlock.appendChild(explanationDiv);
                    this.highlightAnsweredOptions(optionsDiv, index, questionData.correctAnswer);
                }
                
                return questionBlock;
            }

            createOptionsDiv(questionData, index, isReview) {
                const optionsDiv = document.createElement('div');
                optionsDiv.classList.add('options');
                
                questionData.options.forEach((option, i) => {
                    const label = document.createElement('label');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `question${index}`;
                    radio.id = `q${index}_option${i}`;
                    radio.value = i;
                    
                    label.htmlFor = radio.id;

                    const customRadioSpan = document.createElement('span');
                    customRadioSpan.classList.add('custom-radio');

                    const optionTextSpan = document.createElement('span');
                    optionTextSpan.classList.add('option-text');
                    optionTextSpan.textContent = option;

                    if (this.userAnswers[index] === i && !this.answeredStatus[index] && !isReview) {
                        radio.checked = true;
                        label.classList.add('selected-option');
                    }
                    
                    radio.disabled = this.answeredStatus[index] || isReview;
                    if (isReview || this.answeredStatus[index]) {
                        label.classList.add('answered-option');
                        if (isReview) label.classList.add('disabled-option');
                    }
                    
                    radio.addEventListener('change', () => {
                        if (!this.answeredStatus[index] && !isReview) {
                            this.userAnswers[index] = i;
                            optionsDiv.querySelectorAll('label').forEach(lbl => lbl.classList.remove('selected-option'));
                            label.classList.add('selected-option');
                            this.submitBtn.disabled = false;
                        }
                    });

                    label.appendChild(radio);
                    label.appendChild(customRadioSpan);
                    label.appendChild(optionTextSpan);
                    optionsDiv.appendChild(label);
                });
                
                return optionsDiv;
            }

            createExplanationDiv(questionData, index, isReview) {
                const explanationDiv = document.createElement('div');
                explanationDiv.classList.add('explanation');
                
                let explanationHTML = `<strong>è§£æï¼š</strong> ${questionData.explanation || "æš‚æ— è§£æã€‚"}`; // Default explanation
                
                if (this.userAnswers[index] === questionData.correctAnswer) {
                    explanationDiv.classList.add('correct');
                    if (!isReview) explanationHTML += "<span class='user-answer-indicator'><br><strong>æ‚¨çš„é€‰æ‹©ï¼š</strong> æ­£ç¡®ï¼</span>";
                    else explanationHTML += `<span class='user-answer-indicator'><br><strong>æ‚¨çš„é€‰æ‹©ï¼š</strong> ${questionData.options[this.userAnswers[index]]} (æ­£ç¡®)</span>`;
                } else {
                    explanationDiv.classList.add('incorrect');
                    explanationHTML += `<span class='user-answer-indicator'><br><strong>æ‚¨çš„é€‰æ‹©ï¼š</strong> ${this.userAnswers[index] !== null ? questionData.options[this.userAnswers[index]] : 'æœªé€‰æ‹©'} (é”™è¯¯)</span>`;
                    explanationHTML += `<span class='correct-answer-indicator'><br><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> ${questionData.options[questionData.correctAnswer]}</span>`;
                }
                
                explanationDiv.innerHTML = explanationHTML;
                return explanationDiv;
            }

            highlightAnsweredOptions(optionsDiv, qIndex, correctAnswerIndex) {
                const radioLabels = optionsDiv.querySelectorAll('label');
                radioLabels.forEach((label, i) => {
                    const radioInput = label.querySelector('input[type="radio"]');
                    radioInput.disabled = true;
                    label.classList.remove('selected-option');
                    label.classList.add('answered-option');

                    if (i === correctAnswerIndex) {
                        label.classList.add('correct-answer-highlight');
                    }
                    if (this.userAnswers[qIndex] === i && this.userAnswers[qIndex] !== correctAnswerIndex) {
                        label.classList.add('incorrect-user-choice');
                    }
                });
            }

            handlePrevious() {
                if (this.isReviewMode) {
                    if (this.currentIncorrectReviewIndex > 0) {
                        this.currentIncorrectReviewIndex--;
                        this.displayQuestion(this.incorrectQuestions[this.currentIncorrectReviewIndex], true);
                    }
                } else {
                    if (this.currentQuestionIndex > 0) {
                        this.currentQuestionIndex--;
                        this.displayQuestion(this.currentQuestionIndex);
                    }
                }
            }

            handleNext() {
                if (this.isReviewMode) {
                    if (this.nextBtn.textContent.includes('å®Œæˆå›é¡¾')) {
                        this.endReview();
                    } else if (this.currentIncorrectReviewIndex < this.incorrectQuestions.length - 1) {
                        this.currentIncorrectReviewIndex++;
                        this.displayQuestion(this.incorrectQuestions[this.currentIncorrectReviewIndex], true);
                    }
                } else {
                    if (this.nextBtn.textContent.includes('æŸ¥çœ‹ç»“æœ')) {
                        this.showFinalScore();
                    } else if (this.currentQuestionIndex < this.currentQuizData.length - 1) {
                        this.currentQuestionIndex++;
                        this.displayQuestion(this.currentQuestionIndex);
                    }
                }
            }

            handleSubmit() {
                if (this.userAnswers[this.currentQuestionIndex] === null && !this.answeredStatus[this.currentQuestionIndex]) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆåå†æäº¤ï¼');
                    return;
                }
                if (this.answeredStatus[this.currentQuestionIndex]) return;

                this.answeredStatus[this.currentQuestionIndex] = true;
                if (this.userAnswers[this.currentQuestionIndex] === this.currentQuizData[this.currentQuestionIndex].correctAnswer) {
                    this.score++;
                } else {
                    this.incorrectQuestions.push(this.currentQuestionIndex);
                }
                this.displayQuestion(this.currentQuestionIndex); // Re-display to show explanation
                this.updateProgressBar();
                this.updateNavigationButtons();
            }

            updateNavigationButtons() {
                this.prevBtn.innerHTML = this.isReviewMode ? 'â† ä¸Šä¸€é”™é¢˜' : 'â† ä¸Šä¸€é¢˜';
                this.submitBtn.innerHTML = 'æäº¤ç­”æ¡ˆ âœ“';

                if (this.isReviewMode) {
                    this.prevBtn.disabled = this.currentIncorrectReviewIndex === 0;
                    this.nextBtn.disabled = false;
                    this.nextBtn.innerHTML = (this.currentIncorrectReviewIndex === this.incorrectQuestions.length - 1) ? 'å®Œæˆå›é¡¾ ğŸ' : 'ä¸‹ä¸€é”™é¢˜ â†’';
                } else {
                    this.prevBtn.disabled = this.currentQuestionIndex === 0;
                    if (this.currentQuestionIndex === this.currentQuizData.length - 1) { // Last question
                        if (this.allQuestionsAnswered()) {
                            this.nextBtn.innerHTML = 'æŸ¥çœ‹ç»“æœ ğŸ';
                            this.nextBtn.disabled = false;
                            this.submitBtn.style.display = 'none'; // Hide submit when all answered
                        } else {
                            this.nextBtn.innerHTML = 'ä¸‹ä¸€é¢˜ â†’';
                            this.nextBtn.disabled = true; // Disable next if last q and not all answered
                            this.submitBtn.style.display = this.answeredStatus[this.currentQuestionIndex] ? 'none' : 'inline-flex';
                        }
                    } else { // Not the last question
                        this.nextBtn.innerHTML = 'ä¸‹ä¸€é¢˜ â†’';
                        this.nextBtn.disabled = false; // Enable next for non-last questions
                        this.submitBtn.style.display = this.answeredStatus[this.currentQuestionIndex] ? 'none' : 'inline-flex';
                    }
                    this.submitBtn.disabled = this.answeredStatus[this.currentQuestionIndex] || this.userAnswers[this.currentQuestionIndex] === null;
                }
            }

            allQuestionsAnswered() {
                return this.answeredStatus.every(status => status === true);
            }

            updateProgressBar() {
                const answeredCount = this.answeredStatus.filter(status => status === true).length;
                const progress = this.currentQuizData.length > 0 ? (answeredCount / this.currentQuizData.length) * 100 : 0;
                this.progressBar.style.width = `${progress}%`;
                this.progressBar.textContent = `${Math.round(progress)}%`;
            }

            showFinalScore() {
                this.quizEndTime = new Date();
                const timeTaken = this.quizEndTime - this.quizStartTime;
                const accuracy = this.currentQuizData.length > 0 ? (this.score / this.currentQuizData.length) * 100 : 0;

                this.quizContentArea.style.display = 'none';
                this.navigationControls.style.display = 'none';
                this.progressBarContainer.style.display = 'none';
                
                this.finalScoreContainer.style.display = 'flex';
                this.finalScoreSummaryDiv.innerHTML = `
                    <h3>æµ‹è¯•å®Œæˆï¼</h3>
                    <p><span>æ€»é¢˜ç›®æ•°ï¼š</span> <span>${this.currentQuizData.length}</span></p>
                    <p><span>ç­”å¯¹é¢˜æ•°ï¼š</span> <span>${this.score}</span></p>
                    <p><span>ç­”é”™é¢˜æ•°ï¼š</span> <span>${this.incorrectQuestions.length}</span></p>
                    <p class="accuracy"><span>æ­£ç¡®ç‡ï¼š</span> <span>${accuracy.toFixed(1)}%</span></p>
                    <p><span>æ€»ç”¨æ—¶ï¼š</span> <span>${this.formatTime(timeTaken)}</span></p>
                `;
                this.reviewIncorrectBtn.style.display = this.incorrectQuestions.length > 0 ? 'inline-flex' : 'none';
            }

            startReviewIncorrect() {
                if (this.incorrectQuestions.length === 0) return;
                this.isReviewMode = true;
                this.currentIncorrectReviewIndex = 0;

                this.quizContentArea.style.display = 'block';
                this.navigationControls.style.display = 'block';
                this.finalScoreContainer.style.display = 'none';
                this.progressBarContainer.style.display = 'none'; // Hide progress bar in review mode
                this.submitBtn.style.display = 'none'; // Hide submit button in review mode

                this.displayQuestion(this.incorrectQuestions[this.currentIncorrectReviewIndex], true);
            }

            endReview() {
                this.isReviewMode = false;
                this.showFinalScore(); // Go back to score screen
                // this.submitBtn.style.display = 'inline-flex'; // Not needed if going to score screen
            }

            restart() {
                // Re-initialize for a new attempt on the same quiz
                this.currentQuestionIndex = 0;
                this.userAnswers.fill(null);
                this.answeredStatus.fill(false);
                this.score = 0;
                this.incorrectQuestions = [];
                this.isReviewMode = false;
                this.quizStartTime = new Date();
                
                this.quizContentArea.style.display = 'block';
                this.navigationControls.style.display = 'block';
                this.progressBarContainer.style.display = 'block';
                this.finalScoreContainer.style.display = 'none';
                
                this.submitBtn.style.display = 'inline-flex'; // Show submit button
                this.displayQuestion(this.currentQuestionIndex);
            }

            formatTime(milliseconds) {
                if (milliseconds < 0) milliseconds = 0;
                let totalSeconds = Math.floor(milliseconds / 1000);
                let minutes = Math.floor(totalSeconds / 60);
                let seconds = totalSeconds % 60;
                return `${minutes}åˆ† ${seconds.toString().padStart(2, '0')}ç§’`;
            }
        }

        const quizEngine = new QuizEngine();
    </script>
    
    <script>
        // ===== ADMIN MANAGER =====
        class AdminManager {
            constructor() {
                this.initElements();
                this.setupEventListeners();
            }

            initElements() {
                this.adminToggle = document.getElementById('adminToggle');
                this.adminPanel = document.getElementById('adminPanel');
                this.addQuizForm = document.getElementById('addQuizForm');
                this.subjectSelect = document.getElementById('subjectSelect');
                this.periodSelect = document.getElementById('periodSelect');
                this.customPeriodInput = document.getElementById('customPeriodInput');
                this.quizNameInput = document.getElementById('quizNameInput');
                this.quizDescInput = document.getElementById('quizDescInput');
                this.difficultySelect = document.getElementById('difficultySelect');
                this.estimatedTimeInput = document.getElementById('estimatedTimeInput');
                this.quizDataInput = document.getElementById('quizDataInput');
                this.copyInstructionBtn = document.getElementById('copyInstructionBtn');
                this.backupDataBtn = document.getElementById('backupDataBtn');
                this.restoreDataBtn = document.getElementById('restoreDataBtn');
                this.restoreFileInput = document.getElementById('restoreFileInput');
                this.quizListContent = document.getElementById('quizListContent');
            }

            setupEventListeners() {
                this.adminToggle.addEventListener('click', () => this.togglePanel());

                document.addEventListener('click', (e) => {
                    if (this.adminPanel && !this.adminPanel.contains(e.target) && e.target !== this.adminToggle) {
                        this.adminPanel.classList.remove('active');
                    }
                });

                this.subjectSelect.addEventListener('change', () => this.updatePeriodOptions());

                this.addQuizForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addNewQuiz();
                });

                this.copyInstructionBtn.addEventListener('click', () => this.copyInstructionTemplate());

                this.backupDataBtn.addEventListener('click', () => this.backupData());
                this.restoreDataBtn.addEventListener('click', () => this.restoreFileInput.click());
                this.restoreFileInput.addEventListener('change', (e) => this.restoreData(e));

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.adminPanel && this.adminPanel.classList.contains('active')) {
                        this.adminPanel.classList.remove('active');
                    }
                });
            }

            togglePanel() {
                this.adminPanel.classList.toggle('active');
                if (this.adminPanel.classList.contains('active')) {
                    this.updateQuizList();
                    this.updatePeriodOptions(); // Update period options when panel opens, in case subject changed
                }
            }

            updatePeriodOptions() {
                const subjectId = this.subjectSelect.value;
                this.periodSelect.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
                
                if (subjectId) {
                    const options = DataManager.getPeriodOptions(subjectId);
                    options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.id;
                        optionElement.textContent = option.name;
                        optionElement.setAttribute('data-description', option.description);
                        this.periodSelect.appendChild(optionElement);
                    });
                    
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = 'è‡ªå®šä¹‰åˆ†ç±»...';
                    this.periodSelect.appendChild(customOption);
                }
                
                this.customPeriodInput.style.display = 'none';
                this.customPeriodInput.required = false; // Ensure it's not required by default
                
                this.periodSelect.onchange = () => {
                    if (this.periodSelect.value === 'custom') {
                        this.customPeriodInput.style.display = 'block';
                        this.customPeriodInput.required = true;
                        this.customPeriodInput.focus();
                    } else {
                        this.customPeriodInput.style.display = 'none';
                        this.customPeriodInput.required = false;
                        this.customPeriodInput.value = '';
                    }
                };
                 // Trigger onchange if a period is already selected (e.g., during edit)
                if (this.periodSelect.value === 'custom') {
                    this.customPeriodInput.style.display = 'block';
                    this.customPeriodInput.required = true;
                }
            }

            addNewQuiz() {
                const subjectId = this.subjectSelect.value;
                let periodId = this.periodSelect.value; // Use let as it might be reassigned
                const customPeriodName = this.customPeriodInput.value.trim();
                const quizName = this.quizNameInput.value.trim();
                const quizDesc = this.quizDescInput.value.trim();
                const difficulty = this.difficultySelect.value;
                const estimatedTime = this.estimatedTimeInput.value.trim();
                const questionsDataText = this.quizDataInput.value.trim();

                if (!subjectId) { alert('è¯·é€‰æ‹©å­¦ç§‘ï¼'); return; }
                if (periodId === 'custom' && !customPeriodName) { alert('è¯·è¾“å…¥è‡ªå®šä¹‰åˆ†ç±»åç§°ï¼'); return; }
                if (!periodId && !customPeriodName) { alert('è¯·é€‰æ‹©æˆ–è¾“å…¥æ—¶æœŸåˆ†ç±»ï¼'); return; }
                if (!quizName) { alert('è¯·è¾“å…¥é¢˜åº“åç§°ï¼'); return; }
                if (!questionsDataText) { alert('è¯·è¾“å…¥é¢˜ç›®æ•°æ®ï¼'); return; }


                let questions;
                try {
                    questions = JSON.parse(questionsDataText);
                    if (!Array.isArray(questions) || questions.length === 0) {
                        throw new Error('é¢˜ç›®æ•°æ®å¿…é¡»æ˜¯éç©ºæ•°ç»„');
                    }
                    // Basic validation for each question
                    for(const q of questions) {
                        if (!q.question || !Array.isArray(q.options) || q.options.length === 0 || typeof q.correctAnswer !== 'number' || !q.explanation) {
                            throw new Error('é¢˜ç›®æ•°æ®ç»“æ„ä¸å®Œæ•´ (ç¼ºå°‘ question, options, correctAnswer, æˆ– explanation)');
                        }
                        if (q.correctAnswer < 0 || q.correctAnswer >= q.options.length) {
                             throw new Error(`é¢˜ "${q.question.substring(0,20)}..." çš„ correctAnswer è¶…å‡ºé€‰é¡¹èŒƒå›´ã€‚`);
                        }
                    }
                } catch (error) {
                    alert('é¢˜ç›®æ•°æ®æ ¼å¼é”™è¯¯æˆ–å†…å®¹ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥JSONæ ¼å¼åŠå¿…å¡«å­—æ®µï¼\né”™è¯¯ï¼š' + error.message);
                    return;
                }

                let finalPeriodId, finalPeriodName, finalPeriodDescription;
                
                if (periodId === 'custom' || !periodId) { // Handles both 'custom' and if periodSelect is empty
                    finalPeriodName = customPeriodName;
                    finalPeriodId = finalPeriodName.toLowerCase().replace(/\s+/g, '_').replace(/[^\wĞ°-ÑĞ-Ğ¯Ñ‘Ğ]/g, '') || `custom_${Date.now()}`; // Added Russian chars and fallback
                    finalPeriodDescription = `${finalPeriodName}ç›¸å…³çš„çŸ¥è¯†ä¸é¢˜åº“`;
                } else {
                    const periodOptionsList = DataManager.getPeriodOptions(subjectId); // Renamed to avoid conflict
                    const selectedPeriod = periodOptionsList.find(p => p.id === periodId);
                    if (selectedPeriod) {
                        finalPeriodId = selectedPeriod.id;
                        finalPeriodName = selectedPeriod.name;
                        finalPeriodDescription = selectedPeriod.description;
                    } else {
                        // This case should ideally not happen if periodSelect is populated correctly
                        // but as a fallback, treat as custom if selectedPeriod is not found
                        console.warn(`Selected period ID "${periodId}" not found in options. Treating as custom.`);
                        finalPeriodName = periodId; // Or some other fallback
                        finalPeriodId = periodId.toLowerCase().replace(/\s+/g, '_').replace(/[^\wĞ°-ÑĞ-Ğ¯Ñ‘Ğ]/g, '');
                        finalPeriodDescription = `${finalPeriodName}ç›¸å…³çš„çŸ¥è¯†ä¸é¢˜åº“`;
                        // alert('æ‰€é€‰æ—¶æœŸåˆ†ç±»ä¸å­˜åœ¨ï¼'); return;
                    }
                }

                const quizId = quizName.toLowerCase().replace(/\s+/g, '_').replace(/[^\wĞ°-ÑĞ-Ğ¯Ñ‘Ğ]/g, '') + '_' + Date.now();

                try {
                    const periodPayload = { // Renamed from periodData
                        id: finalPeriodId,
                        name: finalPeriodName,
                        description: finalPeriodDescription
                    };

                    const newQuiz = {
                        id: quizId,
                        name: quizName,
                        description: quizDesc || `${quizName}çš„è¯¦ç»†å†…å®¹`,
                        difficulty: difficulty,
                        estimatedTime: estimatedTime || "æœªçŸ¥", // Default estimated time
                        questions: questions
                    };

                    DataManager.addQuiz(subjectId, periodPayload, newQuiz);

                    this.addQuizForm.reset();
                    this.quizDataInput.value = '';
                    this.subjectSelect.value = ""; // Reset subject select
                    this.periodSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å­¦ç§‘</option>';
                    this.customPeriodInput.style.display = 'none';
                    this.customPeriodInput.value = '';
                    this.customPeriodInput.required = false;


                    this.updateQuizList();
                    
                    if (window.uiManager) {
                        window.uiManager.refreshCurrentPage();
                    }

                    alert('é¢˜åº“æ·»åŠ æˆåŠŸï¼');

                } catch (error) {
                    console.error("Error adding quiz:", error);
                    alert('æ·»åŠ é¢˜åº“å¤±è´¥ï¼š' + error.message);
                }
            }

            deleteQuiz(subjectId, periodId, quizId) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢˜åº“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

                if (DataManager.deleteQuiz(subjectId, periodId, quizId)) {
                    this.updateQuizList();
                    if (window.uiManager) {
                        window.uiManager.refreshCurrentPage();
                    }
                    alert('é¢˜åº“å·²åˆ é™¤ã€‚');
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼Œé¢˜åº“å¯èƒ½ä¸å­˜åœ¨ã€‚');
                }
            }

            editQuiz(subjectId, periodId, quizId) {
                const quiz = DataManager.getQuiz(subjectId, periodId, quizId);
                if (!quiz) {
                    alert('æ— æ³•ç¼–è¾‘ï¼šæœªæ‰¾åˆ°é¢˜åº“ã€‚');
                    return;
                }

                const allQuizData = DataManager.getData(); // Renamed from quizData
                const period = allQuizData[subjectId]?.periods[periodId];

                if (!period) {
                     alert('æ— æ³•ç¼–è¾‘ï¼šæœªæ‰¾åˆ°æ—¶æœŸåˆ†ç±»ã€‚');
                     return;
                }

                this.subjectSelect.value = subjectId;
                this.updatePeriodOptions(); // This will repopulate periodSelect
                
                // Use setTimeout to allow periodSelect to repopulate before setting its value
                setTimeout(() => {
                    // Attempt to find the periodId in the newly populated options
                    const periodOptionExists = Array.from(this.periodSelect.options).some(option => option.value === periodId);

                    if (periodOptionExists) {
                        this.periodSelect.value = periodId;
                        this.customPeriodInput.style.display = 'none';
                        this.customPeriodInput.required = false;
                        this.customPeriodInput.value = '';
                    } else {
                        // If periodId is not a standard option, it must be custom
                        this.periodSelect.value = 'custom';
                        this.customPeriodInput.style.display = 'block';
                        this.customPeriodInput.value = period.name; // Populate with the period's name
                        this.customPeriodInput.required = true;
                    }
                    
                    this.quizNameInput.value = quiz.name;
                    this.quizDescInput.value = quiz.description || '';
                    this.difficultySelect.value = quiz.difficulty;
                    this.estimatedTimeInput.value = quiz.estimatedTime || '';
                    this.quizDataInput.value = JSON.stringify(quiz.questions, null, 2);
                }, 100); // 100ms delay, adjust if needed

                // It's better to update the quiz rather than delete and re-add immediately.
                // For simplicity of this example, we'll delete it first.
                // A more robust approach would be to have an "Update Quiz" button
                // that calls a DataManager.updateQuiz method.
                if (confirm('å°†å¡«å……è¡¨å•ä»¥ç¼–è¾‘æ­¤é¢˜åº“ã€‚ç¼–è¾‘å®Œæˆåï¼Œæ‚¨éœ€è¦é‡æ–°æäº¤ä»¥ä¿å­˜æ›´æ”¹ã€‚\næ³¨æ„ï¼šä¸ºç®€åŒ–æ“ä½œï¼ŒåŸé¢˜åº“å°†å…ˆè¢«åˆ é™¤ã€‚è¯·ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                    DataManager.deleteQuiz(subjectId, periodId, quizId); // Delete the old one
                    this.updateQuizList(); // Update list to reflect deletion
                    if (window.uiManager) {
                        window.uiManager.refreshCurrentPage();
                    }
                    this.adminPanel.classList.add('active'); // Ensure panel is open
                    this.quizNameInput.focus(); // Focus on a field
                } else {
                    // If user cancels, revert any premature changes or do nothing
                    this.subjectSelect.value = ""; // Reset form if edit is cancelled
                    this.periodSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å­¦ç§‘</option>';
                    this.addQuizForm.reset();
                    this.quizDataInput.value = "";
                }
            }

            updateQuizList() {
                const allQuizData = DataManager.getData(); // Renamed
                let listHTML = '';
                let quizCount = 0;
                
                Object.values(allQuizData).forEach(subject => {
                    if (subject && subject.periods && typeof subject.periods === 'object') {
                        Object.values(subject.periods).forEach(period => {
                            if (period && period.quizzes && Array.isArray(period.quizzes)) {
                                period.quizzes.forEach(quiz => {
                                    quizCount++;
                                    listHTML += `
                                        <div class="quiz-item">
                                            <div>
                                                <strong>${quiz.name}</strong><br>
                                                <small>${subject.name} - ${period.name} (${quiz.questions?.length || 0}é¢˜)</small>
                                            </div>
                                            <div>
                                                <button class="edit-btn" onclick="adminManager.editQuiz('${subject.id}', '${period.id}', '${quiz.id}')">
                                                    ç¼–è¾‘
                                                </button>
                                                <button class="delete-btn" onclick="adminManager.deleteQuiz('${subject.id}', '${period.id}', '${quiz.id}')">
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                });
                            }
                        });
                    }
                });
                this.quizListContent.innerHTML = quizCount > 0 ? listHTML : '<p style="text-align:center;color:var(--text-muted);">æš‚æ— é¢˜åº“</p>';
            }

            copyInstructionTemplate() {
                const instruction = `ğŸ“ é¢˜ç›®ç”Ÿæˆä»»åŠ¡æŒ‡ä»¤

è¯·æ ¹æ®æˆ‘æä¾›çš„å­¦ä¹ èµ„æ–™ï¼Œç”Ÿæˆé€‰æ‹©é¢˜é¢˜åº“ï¼Œæ ¼å¼å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ¨¡æ¿ï¼š

\`\`\`json
[
  {
    "section": "ç« èŠ‚æˆ–ä¸»é¢˜åç§° (ä¾‹å¦‚ï¼šå°è±¡æ´¾çš„èµ·æº)",
    "question": "é¢˜ç›®å†…å®¹ (ä¾‹å¦‚ï¼šå°è±¡æ´¾è¿åŠ¨å§‹äºå“ªä¸ªå›½å®¶ï¼Ÿ)",
    "options": [
      "é€‰é¡¹Açš„å®Œæ•´å†…å®¹ (ä¾‹å¦‚ï¼šæ³•å›½)",
      "é€‰é¡¹Bçš„å®Œæ•´å†…å®¹ (ä¾‹å¦‚ï¼šæ„å¤§åˆ©)", 
      "é€‰é¡¹Cçš„å®Œæ•´å†…å®¹ (ä¾‹å¦‚ï¼šè¥¿ç­ç‰™)",
      "é€‰é¡¹Dçš„å®Œæ•´å†…å®¹ (ä¾‹å¦‚ï¼šè‹±å›½)"
    ],
    "correctAnswer": 0,
    "explanation": "è¯¦ç»†çš„è§£æï¼Œè¯´æ˜ä¸ºä»€ä¹ˆè¿™ä¸ªç­”æ¡ˆæ˜¯æ­£ç¡®çš„ (ä¾‹å¦‚ï¼šå°è±¡æ´¾æ˜¯19ä¸–çºªä¸‹åŠå¶åœ¨æ³•å›½å…´èµ·çš„ä¸€åœºé‡è¦çš„è‰ºæœ¯è¿åŠ¨...)"
  }
  // ...æ›´å¤šé¢˜ç›®å¯¹è±¡
]
\`\`\`

ğŸ“‹ æ ¼å¼è¦æ±‚ï¼š
1. **é¡¶çº§æ˜¯JSONæ•°ç»„**: \`[\` å¼€å¤´, \`]\` ç»“å°¾ã€‚
2. **æ¯ä¸ªé¢˜ç›®æ˜¯ä¸€ä¸ªJSONå¯¹è±¡**: \`{\` ... \`}\`ã€‚
3. **sectionå­—æ®µ (å­—ç¬¦ä¸²)**: é¢˜ç›®æ‰€å±çš„ç« èŠ‚ã€ä¸»é¢˜æˆ–çŸ¥è¯†ç‚¹åˆ†ç±»ã€‚åŠ¡å¿…å…·ä½“æ˜ç¡®ã€‚
4. **questionå­—æ®µ (å­—ç¬¦ä¸²)**: é¢˜ç›®çš„å®Œæ•´æè¿°ã€‚å¿…é¡»æ¸…æ™°ã€å‡†ç¡®ï¼Œé¿å…æ­§ä¹‰ã€‚
5. **optionsæ•°ç»„ (å­—ç¬¦ä¸²æ•°ç»„)**: å¿…é¡»åŒ…å«4ä¸ªå­—ç¬¦ä¸²é€‰é¡¹ã€‚å†…å®¹è¦å®Œæ•´ï¼Œä¸è¦åªå†™"é€‰é¡¹A"ã€‚
6. **correctAnswerå­—æ®µ (æ•°å­—)**: æ­£ç¡®ç­”æ¡ˆåœ¨optionsæ•°ç»„ä¸­çš„ç´¢å¼•ã€‚0ä»£è¡¨ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼Œ1ä»£è¡¨ç¬¬äºŒä¸ªï¼Œä»¥æ­¤ç±»æ¨ (0, 1, 2, æˆ– 3)ã€‚
7. **explanationå­—æ®µ (å­—ç¬¦ä¸²)**: å¯¹æ­£ç¡®ç­”æ¡ˆçš„è¯¦ç»†è§£æã€‚è¦è§£é‡Šæ¸…æ¥šåŸç†ã€èƒŒæ™¯çŸ¥è¯†ç‚¹ï¼Œå¸®åŠ©å­¦ä¹ è€…ç†è§£ã€‚

ğŸ¯ é¢˜ç›®è´¨é‡è¦æ±‚ï¼š
- **ç›¸å…³æ€§**: é¢˜ç›®å¿…é¡»ä¸æä¾›çš„å­¦ä¹ èµ„æ–™ç´§å¯†ç›¸å…³ã€‚
- **å‡†ç¡®æ€§**: é¢˜ç›®ã€é€‰é¡¹å’Œç­”æ¡ˆå¿…é¡»å‡†ç¡®æ— è¯¯ã€‚
- **æ¸…æ™°åº¦**: é—®é¢˜å’Œé€‰é¡¹çš„è¡¨è¿°åº”æ¸…æ™°æ˜“æ‡‚ã€‚
- **å¹²æ‰°æ€§**: é”™è¯¯é€‰é¡¹åº”å…·æœ‰åˆç†çš„è¿·æƒ‘æ€§ï¼Œé¿å…ç­”æ¡ˆè¿‡äºæ˜æ˜¾æˆ–æ— å…³ã€‚
- **è¦†ç›–é¢**: å°½å¯èƒ½å…¨é¢åœ°è¦†ç›–å­¦ä¹ èµ„æ–™ä¸­çš„é‡è¦çŸ¥è¯†ç‚¹ã€‚
- **è§£æè´¨é‡**: è§£æåº”å…·æœ‰æ•™è‚²æ„ä¹‰ï¼Œä¸ä»…ä»…æ˜¯é‡å¤ç­”æ¡ˆã€‚
- **æ•°é‡**: æ ¹æ®èµ„æ–™å†…å®¹ï¼Œå»ºè®®ç”Ÿæˆ10-30é“é¢˜ç›®ä¸ºå®œã€‚

ğŸŒŸ é€‚ç”¨èŒƒå›´ï¼š
- è‰ºæœ¯å²ç±»ï¼šè¥¿æ–¹è‰ºæœ¯å²ã€ä¸­å›½ç¾æœ¯å²ã€è‰ºæœ¯æ¦‚è®º
- ä¸–ç•Œå¸¸è¯†ç±»ï¼šæ–‡å²å“²ã€æ³•æ”¿ã€ç†ç§‘ã€å·¥ç§‘ã€å†œä¸šã€åŒ»å­¦ã€æ–‡åŒ–è‰ºæœ¯ç­‰å„é¢†åŸŸåŸºç¡€çŸ¥è¯†

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šæ ¼å¼å’Œè¦æ±‚ï¼Œæ ¹æ®æˆ‘æ¥ä¸‹æ¥æä¾›çš„å­¦ä¹ èµ„æ–™ç”Ÿæˆé«˜è´¨é‡çš„é¢˜åº“JSONæ•°æ®ã€‚

---

æˆ‘çš„å­¦ä¹ èµ„æ–™ï¼š
[è¯·åœ¨æ­¤å¤„ç²˜è´´æ‚¨çš„å­¦ä¹ èµ„æ–™]`;

                navigator.clipboard.writeText(instruction).then(() => {
                    const originalText = this.copyInstructionBtn.textContent;
                    this.copyInstructionBtn.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                    this.copyInstructionBtn.style.background = '#48bb78'; // Green for success
                    setTimeout(() => {
                        this.copyInstructionBtn.textContent = originalText;
                        this.copyInstructionBtn.style.background = '#3182ce'; // Original blue
                    }, 2000);
                }).catch(err => {
                    console.error('æ— æ³•è‡ªåŠ¨å¤åˆ¶: ', err);
                    alert('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹æŒ‡ä»¤ï¼š\n\n' + instruction);
                });
            }

            backupData() {
                try {
                    const backupData = DataManager.getBackupData();
                    
                    const now = new Date();
                    const timestamp = now.toISOString().slice(0, 19).replace(/[T:]/g, '_'); // YYYY-MM-DD_HH_MM_SS
                    const filename = `å­¦ä¹ åŠ©æ‰‹é¢˜åº“å¤‡ä»½_${timestamp}.json`;

                    const dataStr = JSON.stringify(backupData, null, 2); // Pretty print JSON
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);

                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = filename;
                    downloadLink.style.display = 'none'; // Hidden link
                    document.body.appendChild(downloadLink);
                    downloadLink.click(); // Trigger download
                    document.body.removeChild(downloadLink); // Clean up

                    setTimeout(() => URL.revokeObjectURL(url), 100); // Release object URL

                    const originalText = this.backupDataBtn.textContent;
                    this.backupDataBtn.textContent = 'âœ… å¤‡ä»½æˆåŠŸï¼';
                    this.backupDataBtn.style.background = '#48bb78';
                    setTimeout(() => {
                        this.backupDataBtn.textContent = originalText;
                        this.backupDataBtn.style.background = '#805ad5'; // Original purple
                    }, 2000);
                    console.log('æ•°æ®å¤‡ä»½æˆåŠŸ:', filename);
                } catch (error) {
                    console.error('å¤‡ä»½å¤±è´¥:', error);
                    alert('æ•°æ®å¤‡ä»½å¤±è´¥ï¼Œè¯·é‡è¯•ï¼\né”™è¯¯ï¼š' + error.message);
                }
            }

            restoreData(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.name.toLowerCase().endsWith('.json')) {
                    alert('è¯·é€‰æ‹©JSONæ ¼å¼çš„å¤‡ä»½æ–‡ä»¶ï¼');
                    this.restoreFileInput.value = ''; // Reset file input
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        
                        let dataToRestore;
                        // Check for our backup structure or a raw data structure
                        if (jsonData && jsonData.data && jsonData.version) { // Our backup structure
                            dataToRestore = jsonData.data;
                        } else if (jsonData && (jsonData.western_art || jsonData.world_knowledge)) { // Raw data structure
                            dataToRestore = jsonData;
                        } else {
                            throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•è¯†åˆ«ä¸ºæœ‰æ•ˆçš„é¢˜åº“æ•°æ®æˆ–å¤‡ä»½æ–‡ä»¶ã€‚');
                        }

                        // Validate the data structure before attempting to restore
                        if (!DataManager.validateQuizData(dataToRestore)) {
                            throw new Error('å¤‡ä»½æ–‡ä»¶ä¸­çš„æ•°æ®ç»“æ„éªŒè¯å¤±è´¥ï¼Œæ— æ³•æ¢å¤ã€‚è¯·ç¡®ä¿æ–‡ä»¶å†…å®¹ç¬¦åˆé¢„æœŸçš„é¢˜åº“æ ¼å¼ã€‚');
                        }
                        
                        const currentQuizData = DataManager.getData(); // Renamed
                        const statsBefore = DataManager.getDataStatistics(currentQuizData);
                        const hasExistingData = statsBefore.quizzes > 0;

                        let shouldProceed = true;
                        if (hasExistingData) {
                            shouldProceed = confirm(
                                'æ£€æµ‹åˆ°ç°æœ‰é¢˜åº“æ•°æ®ã€‚\n\né€‰æ‹©"ç¡®å®š"å°†ç”¨å¤‡ä»½æ–‡ä»¶ä¸­çš„æ•°æ®ã€å®Œå…¨æ›¿æ¢ã€‘ç°æœ‰æ‰€æœ‰æ•°æ®ã€‚\né€‰æ‹©"å–æ¶ˆ"å°†ä¸­æ­¢æ¢å¤æ“ä½œã€‚\n\nå¼ºçƒˆå»ºè®®åœ¨æ‰§è¡Œæ­¤æ“ä½œå‰å…ˆå¤‡ä»½å½“å‰æ•°æ®ï¼'
                            );
                        }

                        if (!shouldProceed) {
                            this.restoreFileInput.value = '';
                            return;
                        }

                        DataManager.restoreData(dataToRestore); // This now directly assigns and saves

                        this.updateQuizList();
                        if (window.uiManager) {
                            window.uiManager.init(); // Re-initialize UI to reflect new data from home
                        }

                        const originalText = this.restoreDataBtn.textContent;
                        this.restoreDataBtn.textContent = 'âœ… æ¢å¤æˆåŠŸï¼';
                        this.restoreDataBtn.style.background = '#48bb78';
                        setTimeout(() => {
                            this.restoreDataBtn.textContent = originalText;
                            this.restoreDataBtn.style.background = '#38a169'; // Original green
                        }, 2000);

                        const statsAfter = DataManager.getDataStatistics();
                        alert(`æ•°æ®æ¢å¤æˆåŠŸï¼\n\nğŸ“Š æ¢å¤ç»Ÿè®¡ï¼š\nâ€¢ å­¦ç§‘æ•°é‡ï¼š${statsAfter.subjects}\nâ€¢ åˆ†ç±»æ•°é‡ï¼š${statsAfter.periods}\nâ€¢ é¢˜åº“æ•°é‡ï¼š${statsAfter.quizzes}\nâ€¢ é¢˜ç›®æ€»æ•°ï¼š${statsAfter.questions}`);
                        console.log('æ•°æ®æ¢å¤æˆåŠŸ:', statsAfter);

                    } catch (error) {
                        console.error('æ•°æ®æ¢å¤å¤±è´¥:', error);
                        alert('æ•°æ®æ¢å¤å¤±è´¥ï¼\n\nå¯èƒ½çš„åŸå› ï¼š\nâ€¢ æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚\nâ€¢ æ–‡ä»¶å†…å®¹ä¸ç¬¦åˆé¢˜åº“æ•°æ®ç»“æ„ã€‚\nâ€¢ æ–‡ä»¶å·²æŸåã€‚\n\né”™è¯¯è¯¦æƒ…ï¼š' + error.message);
                    }
                    this.restoreFileInput.value = ''; // Reset file input in all cases
                };

                reader.onerror = () => {
                    alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                    this.restoreFileInput.value = '';
                };
                reader.readAsText(file);
            }
        }

        const adminManager = new AdminManager();
    </script>
    
    <script>
        // ===== UI MANAGER =====
        class UIManager {
            constructor() {
                this.currentState = {
                    level: 'home',
                    subject: null,
                    period: null,
                    quiz: null
                };
                
                this.initElements();
                this.setupEventListeners();
            }

            initElements() {
                this.breadcrumb = document.getElementById('breadcrumb');
                this.cardsGrid = document.getElementById('cardsGrid');
            }

            setupEventListeners() {
                this.breadcrumb.addEventListener('click', (e) => {
                    const item = e.target.closest('.breadcrumb-item');
                    if (!item || item.classList.contains('current')) return;
                    
                    const level = item.dataset.level;
                    this.navigateToLevel(level, item.dataset);
                });
            }

            navigateToLevel(level, data = {}) {
                switch (level) {
                    case 'home':
                        this.currentState = { level: 'home', subject: null, period: null, quiz: null };
                        this.showHomePage();
                        break;
                    case 'subject':
                        this.currentState = { level: 'subject', subject: data.subject, period: null, quiz: null };
                        this.showSubjectPage(data.subject);
                        break;
                    case 'period':
                        this.currentState = { level: 'period', subject: data.subject, period: data.period, quiz: null };
                        this.showPeriodPage(data.subject, data.period);
                        break;
                }
                this.updateBreadcrumb();
            }

            showHomePage() {
                const allQuizData = DataManager.getData(); // Renamed
                const subjects = Object.values(allQuizData).filter(subject => 
                    subject && subject.periods && Object.keys(subject.periods).length > 0
                );
                
                this.cardsGrid.innerHTML = subjects.map(subject => {
                    const totalQuizzes = Object.values(subject.periods).reduce((sum, period) => sum + (period.quizzes ? period.quizzes.length : 0), 0);
                    return `
                        <div class="card" onclick="uiManager.navigateToSubject('${subject.id}')">
                            <div class="card-icon">${subject.icon || 'ğŸ“š'}</div>
                            <h3>${subject.name}</h3>
                            <p>${subject.description}</p>
                            <div class="card-meta">
                                <span>${Object.keys(subject.periods).length} ä¸ªåˆ†ç±»</span>
                                <span>${totalQuizzes} ä¸ªé¢˜åº“</span>
                            </div>
                        </div>
                    `;
                }).join('') || '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;"><h3>æš‚æ— é¢˜åº“</h3><p>ç‚¹å‡»å³ä¸Šè§’âš™ï¸æŒ‰é’®æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªé¢˜åº“å§ï¼</p></div>';
            }

            showSubjectPage(subjectId) {
                const allQuizData = DataManager.getData(); // Renamed
                const subject = allQuizData[subjectId];
                if (!subject) {
                    console.error(`Subject with ID "${subjectId}" not found.`);
                    this.navigateToLevel('home');
                    return;
                }

                const periods = subject.periods ? Object.values(subject.periods) : [];
                
                this.cardsGrid.innerHTML = periods.map(period => `
                    <div class="card" onclick="uiManager.navigateToPeriod('${subjectId}', '${period.id}')">
                        <div class="card-icon">${period.icon || 'ğŸ“‚'}</div>
                        <h3>${period.name}</h3>
                        <p>${period.description}</p>
                        <div class="card-meta">
                            <span>${period.quizzes?.length || 0} ä¸ªé¢˜åº“</span>
                            <span>â†’</span>
                        </div>
                    </div>
                `).join('') || '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;"><h3>è¯¥å­¦ç§‘ä¸‹æš‚æ— åˆ†ç±»æˆ–é¢˜åº“</h3><p>ç‚¹å‡»å³ä¸Šè§’âš™ï¸æŒ‰é’®æ·»åŠ é¢˜åº“ï¼</p></div>';
            }

            showPeriodPage(subjectId, periodId) {
                const allQuizData = DataManager.getData(); // Renamed
                const period = allQuizData[subjectId]?.periods[periodId];
                if (!period) {
                    console.error(`Period with ID "${periodId}" in subject "${subjectId}" not found.`);
                    this.navigateToLevel('subject', { subject: subjectId });
                    return;
                }

                const quizzes = period.quizzes || [];
                this.cardsGrid.innerHTML = quizzes.map(quiz => `
                    <div class="card">
                        <div class.card-icon">${this.getDifficultyIcon(quiz.difficulty)}</div>
                        <h3>${quiz.name}</h3>
                        <p>${quiz.description}</p>
                        <div class="card-meta">
                            <span class="difficulty-badge difficulty-${quiz.difficulty || 'unknown'}">
                                ${this.getDifficultyText(quiz.difficulty)}
                            </span>
                            <span>${quiz.questions?.length || 0} é¢˜</span>
                        </div>
                        <div style="margin-top: 20px;">
                            <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 16px;">
                                é¢„è®¡ç”¨æ—¶: ${quiz.estimatedTime || "æœªçŸ¥"}
                            </div>
                            <button class="start-quiz-btn" onclick="uiManager.startQuiz('${subjectId}', '${periodId}', '${quiz.id}')">
                                <span>å¼€å§‹æµ‹è¯•</span>
                                <span>â–¶</span>
                            </button>
                        </div>
                    </div>
                `).join('') || '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;"><h3>è¯¥åˆ†ç±»ä¸‹æš‚æ— é¢˜åº“</h3><p>ç‚¹å‡»å³ä¸Šè§’âš™ï¸æŒ‰é’®æ·»åŠ é¢˜åº“ï¼</p></div>';
            }

            updateBreadcrumb() {
                let items = [
                    { level: 'home', text: 'ğŸ  é¦–é¡µ', data: {} }
                ];
                const allQuizData = DataManager.getData(); // Renamed

                if (this.currentState.subject) {
                    const subject = allQuizData[this.currentState.subject];
                    if (subject) {
                        items.push({
                            level: 'subject',
                            text: `${subject.icon || 'ğŸ“š'} ${subject.name}`,
                            data: { subject: this.currentState.subject }
                        });
                    }
                }

                if (this.currentState.period) {
                    const period = allQuizData[this.currentState.subject]?.periods[this.currentState.period];
                    if (period) {
                        items.push({
                            level: 'period',
                            text: `${period.icon || 'ğŸ“‚'} ${period.name}`,
                            data: { subject: this.currentState.subject, period: this.currentState.period }
                        });
                    }
                }

                this.breadcrumb.innerHTML = items.map((item, index) => {
                    const isLast = index === items.length - 1;
                    const isCurrent = isLast;
                    
                    let dataAttrs = '';
                    for (const key in item.data) {
                        if (item.data.hasOwnProperty(key) && item.data[key] !== null && item.data[key] !== undefined) {
                            dataAttrs += `data-${key}="${item.data[key]}" `;
                        }
                    }

                    return `
                        <div class="breadcrumb-item ${isCurrent ? 'current' : ''}" 
                             data-level="${item.level}" 
                             ${dataAttrs.trim()}>
                            ${item.text}
                        </div>
                        ${!isLast ? '<span class="breadcrumb-separator">â€º</span>' : ''}
                    `;
                }).join('');
            }

            refreshCurrentPage() {
                // const allQuizData = DataManager.getData(); // Renamed - not strictly needed here if methods handle it
                
                if (this.currentState.level === 'period' && this.currentState.subject && this.currentState.period) {
                    // Check if data still exists before trying to show
                    const periodExists = DataManager.getData()[this.currentState.subject]?.periods[this.currentState.period];
                    if (periodExists) {
                        this.showPeriodPage(this.currentState.subject, this.currentState.period);
                    } else {
                        this.navigateToLevel('subject', { subject: this.currentState.subject });
                    }
                } else if (this.currentState.level === 'subject' && this.currentState.subject) {
                    const subjectExists = DataManager.getData()[this.currentState.subject];
                    if (subjectExists) {
                        this.showSubjectPage(this.currentState.subject);
                    } else {
                        this.navigateToLevel('home');
                    }
                } else if (this.currentState.level === 'home') {
                    this.showHomePage();
                }
                this.updateBreadcrumb(); // Ensure breadcrumb is also updated
            }

            navigateToSubject(subjectId) {
                this.navigateToLevel('subject', { subject: subjectId });
            }

            navigateToPeriod(subjectId, periodId) {
                this.navigateToLevel('period', { subject: subjectId, period: periodId });
            }

            startQuiz(subjectId, periodId, quizId) {
                quizEngine.start(subjectId, periodId, quizId);
            }

            getDifficultyIcon(difficulty) {
                const icons = {
                    easy: 'ğŸŸ¢',
                    medium: 'ğŸŸ¡',
                    hard: 'ğŸ”´'
                };
                return icons[difficulty] || 'âšª'; // Default for unknown
            }

            getDifficultyText(difficulty) {
                const texts = {
                    easy: 'åˆçº§',
                    medium: 'ä¸­çº§',
                    hard: 'é«˜çº§'
                };
                return texts[difficulty] || 'æœªçŸ¥'; // Default for unknown
            }

            init() {
                this.navigateToLevel('home'); // Start from home, which will call showHomePage and updateBreadcrumb
            }
        }

        const uiManager = new UIManager();
        window.uiManager = uiManager; // Expose to global for HTML onclick
        
        // ===== APP INIT =====
        function initApp() {
            try {
                // DataManager is already initialized via its IIFE
                uiManager.init(); // Initialize UI, which depends on DataManager
                // AdminManager is already initialized
                // QuizEngine is already initialized
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (quizEngine.quizContainer && quizEngine.quizContainer.style.display !== 'none') {
                            quizEngine.close();
                        }
                        if (adminManager.adminPanel && adminManager.adminPanel.classList.contains('active')) {
                            adminManager.adminPanel.classList.remove('active');
                        }
                    }
                });

                window.addEventListener('beforeunload', (e) => {
                    if (quizEngine.currentQuizData && quizEngine.currentQuestionIndex > 0 && !quizEngine.isReviewMode && quizEngine.finalScoreContainer.style.display === 'none') {
                        e.preventDefault();
                        e.returnValue = 'æ‚¨æ­£åœ¨è¿›è¡Œæµ‹è¯•ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿæ‚¨çš„è¿›åº¦å°†ä¸ä¼šè¢«ä¿å­˜ã€‚';
                        return e.returnValue;
                    }
                });

                console.log('å­¦ä¹ åŠ©æ‰‹åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                // Simple alert for critical init errors, or use a more sophisticated error display
                const errorDiv = document.createElement('div');
                errorDiv.textContent = 'åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚é”™è¯¯: ' + error.message;
                errorDiv.style.cssText = "position:fixed;top:10px;left:10px;background:red;color:white;padding:10px;z-index:10000;";
                document.body.prepend(errorDiv);
            }
        }

        // Start the application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp(); // DOMContentLoaded has already fired
        }

        // Global utility/debug functions
        window.app = {
            info: () => ({
                name: 'å­¦ä¹ åŠ©æ‰‹',
                version: '2.1.0 (ä¿®å¤ç‰ˆ)',
                description: 'è‰ºæœ¯å²ä¸ä¸–ç•Œå¸¸è¯†é¢˜åº“ç³»ç»Ÿ'
            }),
            restart: () => {
                if (confirm('ç¡®å®šè¦é‡å¯åº”ç”¨å—ï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚')) {
                    location.reload();
                }
            },
            clearAllData: () => {
                if (confirm('è­¦å‘Šï¼šç¡®å®šè¦æ¸…é™¤æ‰€æœ‰é¢˜åº“æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.removeItem('artQuizData');
                    alert('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ã€‚åº”ç”¨å°†åˆ·æ–°ã€‚');
                    location.reload();
                }
            },
            getStats: () => DataManager.getDataStatistics(),
            exportData: () => {
                const dataStr = JSON.stringify(DataManager.getData(), null, 2);
                const dataBlob = new Blob([dataStr], {type : 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'quizData_export.json';
                a.click();
                URL.revokeObjectURL(url);
                console.log("æ•°æ®å·²å¯¼å‡ºä¸º quizData_export.json");
            }
        };

        // Log debug info in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('ğŸ¯ å­¦ä¹ åŠ©æ‰‹åº”ç”¨ - å¼€å‘æ¨¡å¼');
            console.log('ğŸ“Š åº”ç”¨ä¿¡æ¯:', window.app.info());
            console.log('ğŸ“ˆ å½“å‰æ•°æ®ç»Ÿè®¡:', window.app.getStats());
            console.log('ğŸ’¡ å¯ç”¨å‘½ä»¤:', Object.keys(window.app));
        }
    </script>
</body>
</html>