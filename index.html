<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习助手 - 艺术史与世界常识</title>
    <!-- 统一引入所有模块化的 CSS 文件 -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/cards.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/ai-features.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/quiz-engine.css">
    <link rel="stylesheet" href="css/review-manager.css">
    <link rel="stylesheet" href="css/statistics-manager.css">
    <link rel="stylesheet" href="css/utilities.css">
    
    <!-- 新增：引入左侧侧边栏的CSS -->
    <link rel="stylesheet" href="css/right-sidebar.css">
    <!-- 原ai-diagnostic.css现在主要用于AI聊天内容的样式，而非对话框本身 -->
    <link rel="stylesheet" href="css/ai-diagnostic.css">

    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Sidebar Toggle Button - MOVED TO TOP LEVEL OF BODY -->
    <!-- 这个按钮现在负责整个左侧面板的打开/关闭 -->
    <button class="sidebar-toggle" id="leftSidebarToggle" title="打开/关闭侧边栏">
        <span class="arrow-icon">▶</span>
    </button>

    <!-- Left Sidebar Container -->
    <div class="right-sidebar" id="leftSidebar">
        <!-- 侧边栏宽度调节手柄 - MODIFIED: Moved inside right-sidebar and is its first child -->
        <div class="sidebar-resizer" id="sidebarResizer"></div>
        <div class="sidebar-content-wrapper" id="sidebarContentWrapper">
            <!-- Tab 导航区 -->
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="ai-chat">🧠 AI助手</button>
                <button class="sidebar-tab" data-tab="admin-panel">⚙️ 管理</button>
            </div>

            <!-- AI Chat Section (formerly aiDiagnosticDialog content) -->
            <div class="sidebar-section active" id="aiChatSection">
                <div class="ai-chat-header">
                    <span class="ai-chat-title">AI助手</span>
                    <!-- AI功能模式按钮 (作为按钮组) -->
                    <div class="ai-chat-modes">
                        <button class="ai-chat-mode-btn active" data-mode="general" title="通用对话">💬</button>
                        <button class="ai-chat-mode-btn" data-mode="diagnose" title="学情诊断">📊</button>
                        <button class="ai-chat-mode-btn" data-mode="hint" title="题目提示">💡</button>
                        <button class="ai-chat-mode-btn" data-mode="explain" title="题目解析">📝</button>
                        <!-- 新增的按钮，专门用于平行时空的题目互动 -->
                        <button class="ai-chat-mode-btn" data-mode="essay_feedback" title="平行时空扩展">🌍</button>
                    </div>
                </div>
                <div class="chat-display-area" id="aiChatDisplay">
                    <!-- 消息会显示在这里 -->
                </div>
                <div class="chat-input-area">
                    <textarea id="aiChatInput" placeholder="输入你的问题或请求..." rows="1"></textarea>
                    <button id="aiChatSendBtn" class="action-btn primary">发送</button>
                </div>
                <div class="chat-actions">
                    <button id="aiChatNewChatBtn" class="action-btn secondary">新对话</button>
                    <button id="aiChatAbortBtn" class="action-btn danger" style="display: none;">中止</button>
                    <span id="aiChatLoading" style="display: none;">🧠思考中...</span>
                </div>
            </div>

            <!-- Admin Panel Section (existing admin-panel content moved here) -->
            <div class="sidebar-section" id="adminPanelSection">
                <!-- AI服务用量 (估算) - MOVED HERE -->
                <div class="api-usage-stats-container" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee;">
                    <h4>📊 AI服务用量 (估算)</h4>
                    <div class="api-stat-item">
                        <span>今日已用/剩余调用：</span>
                        <strong id="apiTodayUsed">0</strong> / <strong id="apiTodayRemaining">500</strong>
                    </div>
                    <div class="api-progress-bar-container">
                        <div class="api-progress-bar-fill" id="apiTodayProgressBar" style="width: 0%;"></div>
                    </div>
                    <div class="api-stat-item" style="margin-top: 8px;">
                        <span>历史总调用次数：</span>
                        <strong id="apiTotalCalls">0</strong>
                    </div>
                    <div class="api-stat-item" style="margin-top: 8px;">
                        <span>今日已用 Tokens：</span>
                        <strong id="apiTokensToday">0</strong>
                    </div>
                    <div class="api-stat-item" style="margin-top: 8px;">
                        <span>历史累计 Tokens：</span>
                        <strong id="apiTokensTotal">0</strong>
                    </div>
                    <small style="display: block; margin-top: 10px; color: #777; font-size: 0.8em;">
                        * 此为本地估算值，每日自动重置。实际用量请参考云服务控制台。
                    </small>
                    <!-- (可选) 测试用重置按钮 -->
                    <!-- <button onclick="window.apiMetricsManager && window.apiMetricsManager.resetAllCountsForTesting()">重置计数(测试)</button> -->
                </div>
                <!-- END OF MOVED BLOCK -->

                <h3>📚 题库管理</h3>

                <!-- AI助手区块 -->
                <div class="ai-assistant-section" id="aiAssistantSection">
                    <h4>🧠 AI智能助手</h4>
                    <p class="ai-section-desc">使用AI快速生成题库内容，大幅提升创建效率</p>
                    
                    <div class="prompt-builder">
                        <h5>📝 智能Prompt参数设置</h5>
                        
                        <!-- 📌 多行 Prompt 容器 -->
                        <div id="multiPromptRows"></div>

                        <!-- 隐藏模板 -->
                        <template id="promptRowTpl">
                          <div class="prompt-row">
                            <select class="subject-select"></select>
                            <select class="period-select"></select>
                            <input  type="number" class="count-input" value="10" min="1">
                            <button type="button" class="remove-row">🗑</button>
                          </div>
                        </template>

                        <button type="button" id="addPromptRow" class="ai-btn primary">＋ 添加学科/数量组合</button>
                        <!-- END OF NEW MULTI-ROW SECTION -->

                        <!-- GLOBAL SETTINGS (Difficulty, Estimated Time, Reference) -->
                        <h5 style="margin-top:15px; border-top:1px dashed #ccc; padding-top:15px; font-size:1.1rem; margin-bottom:15px;">⚙️ 全局生成设置 (应用于上方所有条目)</h5>
                        <div class="form-row">
                            <div class="form-col">
                                <label>难度等级</label>
                                <select id="aiDifficultySelect">
                                    <option value="easy">初级</option>
                                    <option value="medium" selected>中级</option>
                                    <option value="hard">高级</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>预计用时</label>
                                <select id="aiEstimatedTimeSelect">
                                    <option value="5-10分钟">5-10 分钟</option>
                                    <option value="10-15分钟" selected>10-15 分钟</option>
                                    <option value="15-20分钟">15-20 分钟</option>
                                    <option value="20-30分钟">20-30 分钟</option>
                                    <option value="30-45分钟">30-45 分钟</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <label>参考资料</label>
                                <select id="aiHasReference">
                                    <option value="no">无，AI自主生成</option>
                                    <option value="yes">有，我将提供材料</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <!-- Empty column for alignment or future use -->
                            </div>
                        </div>
                        <!-- END GLOBAL SETTINGS -->
                        
                        <div class="ai-buttons">
                            <button type="button" id="generatePromptBtn" class="ai-btn primary">
                                📄 生成并复制Prompt
                            </button>
                            <button type="button" id="uploadAIResultBtn" class="ai-btn secondary">
                                📥 导入AI结果JSON
                            </button>
                        </div>
                        
                        <div class="ai-tips">
                            <p><strong>💡 使用提示：</strong></p>
                            <p>1. 设置学科、时期、数量（可添加多行），以及全局参数</p>
                            <p>2. 点击「生成并复制Prompt」</p>
                            <p>3. 将指令粘贴到AI工具中获取JSON结果</p>
                            <p>4. 点击「导入AI结果JSON」导入题库</p>
                        </div>
                    </div>
                </div>

                <!-- 传统添加题库表单 (注释掉) -->
                <!--
                <form class="admin-form" id="addQuizForm">
                    <label>学科分类</label>
                    <select id="subjectSelect" required>
                        <option value="">请选择学科</option>
                        <option value="western_art">外国艺术史</option>
                        <option value="chinese_art">中国美术史</option>
                        <option value="art_theory">艺术概论</option>
                        <option value="postgraduate_politics">考研政治</option>
                        <option value="world_knowledge">世界常识</option>
                        <option value="english_mcq">英语选择题</option>
                    </select>

                    <label>时期分类</label>
                    <select id="periodSelect" required>
                        <option value="">请先选择学科</option>
                    </select>
                    <input type="text" id="customPeriodInput" placeholder="或输入自定义分类名称" style="margin-top: 8px;">

                    <label>题库名称</label>
                    <input type="text" id="quizNameInput" placeholder="如：印象派初级题库、文史基础100题" required>

                    <label>题库描述</label>
                    <textarea id="quizDescInput" placeholder="简要描述这个题库的内容" rows="3"></textarea>

                    <label>难度等级</label>
                    <select id="difficultySelect" required>
                        <option value="easy">初级</option>
                        <option value="medium">中级</option>
                        <option value="hard">高级</option>
                    </select>

                    <label>预计用时</label>
                    <input type="text" id="estimatedTimeInput" placeholder="如：15-20分钟" required>

                    <button type="submit">✅ 添加题库</button>
                </form>
                -->

                <!-- 数据备份管理区域 -->
                <div class="backup-section">
                    <h4>💾 数据备份管理</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        <button type="button" id="backupDataBtn" style="background: var(--secondary-color); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; cursor: pointer; font-weight: 500;">
                            📦 备份数据
                        </button>
                        <button type="button" id="restoreDataBtn" style="background: var(--success-color); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; cursor: pointer; font-weight: 500;">
                            📂 恢复数据
                        </button>
                    </div>
                    <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
                    <div style="font-size: 0.85em; color: var(--text-muted); line-height: 1.4; margin-bottom: 15px;">
                        💡 <strong>使用说明：</strong><br>
                        • 备份：同时在内部创建备份并下载当前所有题库数据到本地JSON文件<br>
                        • 恢复：选择备份的JSON文件来恢复题库数据<br>
                        • 建议定期备份，防止数据丢失
                    </div>
                    <!-- MODIFIED: Added container for backup list -->
                    <h5>📦 内部备份列表</h5>
                    <div id="adminBackupListContainer" class="backup-list" style="margin-top: 10px; margin-bottom:15px; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
                        <!-- Backup list will be rendered here by JS -->
                        <p style="padding: 10px; text-align: center; color: var(--text-muted);">正在加载备份列表...</p>
                    </div>
                    <div style="font-size: 0.85em; color: var(--text-muted); line-height: 1.4;">
                        • "清理存储"功能会自动保留最近10条内部备份并删除更早的备份。<br>
                        • 您也可以在此手动删除特定的内部备份。
                    </div>
                </div>

                <!-- 存储状态管理区域 -->
                <div class="storage-status-section">
                    <h4>💾 存储状态</h4>
                    <div id="storageStatusInfo" class="storage-info-grid">
                        <!-- 存储状态信息将在这里显示 -->
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <button type="button" id="checkStorageBtn" style="background: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; cursor: pointer; font-weight: 500;">
                            📊 检查存储状态
                        </button>
                        <button type="button" id="cleanupStorageBtn" style="background: var(--warning-color); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; cursor: pointer; font-weight: 500;">
                            🗑️ 清理存储
                        </button>
                    </div>
                    <div style="margin-top: 10px;">
                        <button type="button" id="exportAllDataBtn" style="background: var(--success-color); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; cursor: pointer; font-weight: 500; width: 100%;">
                            📤 导出完整数据
                        </button>
                    </div>
                    <div style="font-size: 0.85em; color: var(--text-muted); line-height: 1.4; margin-top: 10px;">
                        💡 <strong>存储说明：</strong><br>
                        • 系统优先使用IndexedDB（支持大容量）<br>
                        • 不支持时自动回退到localStorage<br>
                        • 定期检查存储状态，及时清理数据
                    </div>
                </div>

                <!-- 题目数据编辑器 (注释掉) -->
                <!--
                <div class="quiz-data-editor">
                    <h4>📝 题目数据 (手动添加/编辑时使用)</h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <p style="font-size: 0.9em; color: var(--text-muted); margin: 0; flex: 1;">
                            在下方粘贴题目数据（JSON格式），点击"添加题库"时会自动读取
                        </p>
                        <button type="button" id="copyInstructionBtn" style="background: #3182ce; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8em; cursor: pointer; white-space: nowrap;">
                            📄 获取AI生成指令
                        </button>
                    </div>
                    <textarea id="quizDataInput" placeholder='手动添加题目时，请粘贴JSON数组格式的题目数据。
示例 (单选题):
[
  {
    "section": "章节名",
    "question": "问题内容?",
    "options": ["选项A", "选项B", "选项C"],
    "correctAnswer": 0, // 选项A是正确答案
    "explanation": "这是解析..."
  }
]
示例 (多选题，至少两个正确答案):
[
  {
    "section": "章节名",
    "question": "问题内容 (多选)?",
    "options": ["选项A", "选项B", "选项C", "选项D"],
    "correctAnswers": [0, 2], // 选项A和C是正确答案
    "explanation": "这是多选题的解析..."
  }
]
AI助手生成的Prompt已改为直接复制到剪贴板。'></textarea>
                </div>
                -->

                <div class="quiz-list" id="quizList">
                    <h4>📋 现有题库</h4>
                    <div id="quizListContent">
                        <!-- 题库列表将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI上传模态框 -->
    <div class="modal-overlay" id="aiUploadModal">
        <div class="modal-content ai-upload-modal">
            <div class="modal-header">
                <h3>📥 导入AI生成的题库JSON</h3>
                <button class="modal-close" id="closeAIModal">×</button>
            </div>
            <div class="modal-body">
                <div class="method-tabs">
                    <button class="tab-btn active" data-method="paste">📋 粘贴数据</button>
                    <button class="tab-btn" data-method="upload">📁 上传文件</button>
                </div>
                
                <div class="upload-method active" id="pasteMethod">
                    <div class="method-description">
                        <p>将AI生成的JSON数据粘贴到下方文本框中：</p>
                    </div>
                    <!-- MODIFIED PLACEHOLDER -->
                    <textarea id="aiJsonInput" placeholder='粘贴AI生成的JSON数据。
推荐格式 (题库对象，可包含单选题和多选题):
{
  "quizzes": [
    {
      "subject": "外国艺术史", 
      "period": "印象派",
      "name": "印象派综合题库",
      "description": "关于印象派的题目",
      "difficulty": "medium",
      "estimatedTime": "10-15分钟",
      "questions": [
        { // 单选题示例
          "section": "画家",
          "question": "哪位是印象派的代表画家?",
          "options": ["梵高", "莫奈", "毕加索"],
          "correctAnswer": 1,
          "explanation": "莫奈是印象派的创始人之一。"
        },
        { // 多选题示例 (correctAnswers 数组至少包含两个有效索引)
          "section": "特点",
          "question": "印象派绘画有哪些主要特点 (多选)?",
          "options": ["注重光影", "色彩鲜明", "线条精确", "主题写实"],
          "correctAnswers": [0, 1], 
          "explanation": "印象派强调捕捉光影的瞬间变化和鲜明的色彩。"
        }
      ]
    }
  ]
}

如果AI只返回了题目数组 (questions array):
[ /* 包含单选和多选格式的题目对象... */ ]
系统将使用您在AI助手表单中选择的学科、时期等信息自动创建题库。
确保多选题使用 "correctAnswers": [索引数组] 字段，且数组长度>=2。
单选题使用 "correctAnswer": 索引数字 字段。
'></textarea>
                </div>
                
                <div class="upload-method" id="uploadMethod">
                    <div class="method-description">
                        <p>选择或拖拽AI生成的JSON文件：</p>
                    </div>
                    <div class="file-drop-zone" id="fileDropZone">
                        <div class="drop-zone-content">
                            <div class="drop-zone-icon">📁</div>
                            <div class="drop-zone-text">
                                <p><strong>拖拽JSON文件到此处</strong></p>
                                <p>或点击选择文件</p>
                            </div>
                            <input type="file" id="aiFileInput" accept=".json" style="display: none;">
                        </div>
                    </div>
                    <div class="file-info" id="fileInfo" style="display: none;">
                        <p>已选择文件: <span id="fileName"></span></p>
                        <p>文件大小: <span id="fileSize"></span></p>
                    </div>
                </div>
                
                <div class="ai-import-options">
                    <h5>📝 导入设置 (当JSON包含多个题库或元数据时)</h5>
                    <div class="form-row">
                        <div class="form-col">
                            <label>学科覆盖</label>
                            <select id="importSubjectSelect">
                                <option value="">优先使用JSON内学科</option>
                                <option value="western_art">强制 外国艺术史</option>
                                <option value="chinese_art">强制 中国美术史</option>
                                <option value="art_theory">强制 艺术概论</option>
                                <option value="postgraduate_politics">强制 考研政治</option>
                                <option value="world_knowledge">强制 世界常识</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>冲突处理</label>
                            <select id="conflictResolution">
                                <option value="skip">跳过同名题库</option>
                                <option value="replace">替换同名题库</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="ai-btn secondary" id="cancelImportBtn">取消</button>
                <button class="ai-btn primary" id="processImportBtn">🚀 开始导入</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navigation Breadcrumb -->
        <nav class="breadcrumb" id="breadcrumb">
            <div class="breadcrumb-item current" data-level="home">
                🏠 首页
            </div>
        </nav>

        <!-- Main Navigation Menu -->
        <div class="main-navigation" id="mainNavigation">
            <button class="nav-tab active" data-tab="subjects">📚 题库</button>
            <button class="nav-tab" data-tab="review">📝 错题回顾</button>
            <button class="nav-tab" data-tab="statistics">📊 学习统计</button>
        </div>

        <!-- Daily Test Button -->
        <div style="text-align: center; margin-bottom: 30px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
            <button id="dailyTestBtn" class="start-quiz-btn" style="width: auto; padding: 14px 28px; font-size: 1.05em;">📅 每日一测</button>
            <!-- 新增 AI 对决按钮 -->
            <button id="aiDuelBtn" class="start-quiz-btn" style="width: auto; padding: 14px 28px; font-size: 1.05em;">⚔️ AI对决</button>
            <!-- 新增：打开AI诊断对话框的按钮 -->
            <!-- 这个按钮现在将打开左侧的AI助手侧边栏，而非独立的Modal -->
            <!-- <button id="openAiDiagnosticButton" class="start-quiz-btn" style="width: auto; padding: 14px 28px; font-size: 1.05em; background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white; border: none;">�� AI助手</button> -->
        </div>

        <main class="main-content">
            <!-- 题库页面 -->
            <div class="tab-content active" id="subjectsTab">
                <div class="cards-grid" id="cardsGrid">
                    <!-- Content will be dynamically generated -->
                </div>
            </div>

            <!-- 错题回顾页面 -->
            <div class="tab-content" id="reviewTab">
                <div class="review-page">
                    <div class="review-header">
                        <h2>📝 错题回顾</h2>
                        <div class="review-actions">
                            <button id="startReviewBtn" class="action-btn primary">
                                🎯 开始练习
                            </button>
                            <button id="viewModeBtn" class="action-btn secondary">
                                👁️ 浏览模式
                            </button>
                            <button id="exportIncorrectBtn" class="action-btn secondary">
                                📤 导出错题
                            </button>
                        </div>
                    </div>

                    <!-- 筛选面板 -->
                    <div class="filters-panel" id="reviewFiltersPanel">
                        <div class="filters-row">
                            <div class="filter-group">
                                <label>学科筛选</label>
                                <select id="reviewSubjectFilter">
                                    <option value="">所有学科</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>分类筛选</label>
                                <select id="reviewPeriodFilter">
                                    <option value="">所有分类</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>标记状态</label>
                                <select id="reviewMarkedFilter">
                                    <option value="">全部</option>
                                    <option value="true">已标记</option>
                                    <option value="false">未标记</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>掌握程度</label>
                                <select id="reviewMasteryFilter">
                                    <option value="">全部</option>
                                    <option value="0">需加强 (0星)</option>
                                    <option value="1">较差 (1星)</option>
                                    <option value="2">一般 (2星)</option>
                                    <option value="3">良好 (3星及以上)</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>排序方式</label>
                                <select id="reviewSortBy">
                                    <option value="addedDate">收录时间</option>
                                    <option value="reviewCount">复习次数</option>
                                    <option value="masteryLevel">掌握程度</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <button id="clearReviewFilters" class="action-btn clear">
                                    🔄 清除筛选
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 错题统计 -->
                    <div class="review-stats" id="incorrectQuestionsCount">
                        <!-- 统计数据将在这里显示 -->
                    </div>

                    <!-- 错题列表 -->
                    <div class="incorrect-questions-list" id="incorrectQuestionsList">
                        <!-- 错题列表将在这里显示 -->
                    </div>
                </div>
            </div>

            <!-- 学习统计页面 -->
            <div class="tab-content" id="statisticsTab">
                <div class="statistics-page">
                    <div class="statistics-header">
                        <h2>📊 学习统计</h2>
                        <div class="statistics-actions">
                            <select id="timeRangeSelector" class="time-range-select">
                                <option value="7d">最近7天</option>
                                <option value="30d">最近30天</option>
                                <option value="90d">最近90天</option>
                                <option value="all">全部时间</option>
                            </select>
                            <button id="refreshStatsBtn" class="action-btn secondary">
                                🔄 刷新
                            </button>
                            <button id="exportStatsBtn" class="action-btn secondary">
                                📥 导出报告
                            </button>
                        </div>
                    </div>

                    <!-- 概览统计 -->
                    <div class="overview-section" id="overviewSection">
                        <div class="stats-overview">
                            <div class="stat-card">
                                <div class="stat-icon">📚</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="totalQuizzes">0</span>
                                    <span class="stat-label">完成测验数</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">✏️</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="totalQuestionsAnswered">0</span>
                                    <span class="stat-label">总回答次数</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">✅</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="totalCorrectAttempts">0</span>
                                    <span class="stat-label">累计答对次数</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">❌</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="totalIncorrectAttempts">0</span>
                                    <span class="stat-label">累计答错次数</span>
                                </div>
                            </div>
                            <div class="stat-card"> <!-- 整体正确率 -->
                                <div class="stat-icon">🎯</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="overallAccuracy">0%</span>
                                    <span class="stat-label">整体正确率</span>
                                    <!-- JS中会动态添加解释 -->
                                </div>
                            </div>
                            <div class="stat-card"> <!-- 总题库数 (系统) -->
                                <div class="stat-icon">🗂️</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="totalSystemQuizzes">0</span>
                                    <span class="stat-label">总题库数 (系统)</span>
                                </div>
                            </div>
                            <div class="stat-card"> <!-- 总题目数 (系统) -->
                                <div class="stat-icon">📜</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="totalSystemQuestions">0</span>
                                    <span class="stat-label">总题目数 (系统)</span>
                                </div>
                            </div>
                            <div class="stat-card"> <!-- 已完成题库 (用户) -->
                                <div class="stat-icon">🏆</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="completedUserQuizzes">0</span>
                                    <span class="stat-label">已完成题库 (用户)</span>
                                </div>
                            </div>
                            <div class="stat-card"> <!-- 总有效学习时长 -->
                                <div class="stat-icon">⏳</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="totalEffectiveTime">0秒</span>
                                    <span class="stat-label">总有效学习时长</span>
                                </div>
                            </div>
                            <div class="stat-card"> <!-- 错题本收录 -->
                                <div class="stat-icon">📖</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="uniqueIncorrectInBook">0</span>
                                    <span class="stat-label">错题本收录</span>
                                </div>
                            </div>
                            <div class="stat-card"> <!-- 当前连胜 -->
                                <div class="stat-icon">🔥</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="studyStreak">0</span>
                                    <span class="stat-label">当前连胜</span>
                                </div>
                            </div>
                            <div class="stat-card"> <!-- 学习天数 -->
                                <div class="stat-icon">📅</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="studyDays">0</span>
                                    <span class="stat-label">学习天数</span>
                                </div>
                            </div>
                            <div class="stat-card"> <!-- 平均用时/题 -->
                                <div class="stat-icon">⏱️</div>
                                <div class="stat-content">
                                    <span class="stat-value" id="averageTime">0秒</span>
                                    <span class="stat-label">平均用时/题</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 图表区域 -->
                    <div class="charts-section" id="chartsSection">
                        <div class="charts-grid">
                            <div class="chart-container">
                                <canvas id="accuracyChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="timeChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="subjectChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="difficultyChart"></canvas>
                            </div>
                            <div class="chart-container wide">
                                <!-- 使用 div 作为日历热力图的容器 -->
                                <div id="calendarChart" class="calendar-heatmap-wrapper">
                                    <!-- SVG/Custom HTML 将被插入这里 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 成就展示 -->
                    <div class="achievements-section" id="achievementsSection">
                        <div id="achievementsList">
                            <!-- 成就列表将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Quiz Container (内嵌题库引擎) -->
    <div class="quiz-container embedded" id="quizContainer">
        <div class="quiz-wrapper">
            <header class="quiz-header">
                <button class="quiz-close-btn" id="quizCloseBtn">×</button>
                <h1 id="quizTitle">题库标题</h1>
                <p id="quizSubtitle">题库描述</p>
            </header>

            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>

            <div class="quiz-content-area" id="quizContentArea">
                <div id="quiz-area">
                    <!-- Single question will be displayed here -->
                </div>
            </div>

            <div class="final-score-container" id="finalScoreContainer">
                <div id="finalScoreSummary" class="final-score-summary">
                    <!-- Final score will be shown here -->
                </div>
                <div class="final-score-actions">
                    <button id="review-incorrect-btn" class="nav-btn">
                        🔍 回顾错题
                    </button>
                    <button id="restart-btn" class="nav-btn">
                        🔄 重新开始
                    </button>
                </div>
            </div>

            <div class="navigation-controls" id="navigationControls">
                <div class="navigation-buttons">
                    <button id="prev-btn" class="nav-btn">
                        ← 上一题
                    </button>
                    <button id="submit-btn" class="submit-btn-single nav-btn">
                        提交答案 ✓
                    </button>
                    <button id="next-btn" class="nav-btn">
                        下一题 →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 错题回顾容器 (全屏模式) -->
    <div class="review-container" id="reviewContainer" style="display: none;">
        <div class="review-wrapper">
            <header class="review-header">
                <button class="review-close-btn" id="reviewCloseBtn">×</button>
                <h1 id="reviewTitle">错题复习模式</h1>
                <p id="reviewSubtitle">巩固知识，突破弱点</p>
            </header>

            <div class="review-progress-container" id="reviewProgressContainer">
                <div class="review-progress-bar" id="reviewProgressBar">0%</div>
            </div>

            <div class="review-content-area" id="reviewContentArea">
                <div id="reviewQuestionArea">
                    <!-- 复习题目将在这里显示 -->
                </div>
            </div>

            <div class="review-navigation-controls" id="reviewNavigationControls">
                <div class="review-navigation-buttons">
                    <button id="reviewPrevBtn" class="nav-btn">
                        ← 上一题
                    </button>
                    <button id="reviewSubmitBtn" class="submit-btn-single nav-btn">
                        提交答案 ✓
                    </button>
                    <button id="reviewNextBtn" class="nav-btn">
                        下一题 →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>© <span id="currentYear"></span> 学习助手</p>

        <!-- ****** 新增按钮开始 ****** -->
        <button id="showAgreementBtn" class="footer-link-btn">用户协议与介绍</button>
        <!-- ****** 新增按钮结束 ****** -->

    </footer>

    <!-- 用户协议与介绍模态框 -->
    <div class="modal-overlay" id="userAgreementModal">
        <div class="modal-content" id="agreementModalContent" style="max-width: 650px;">
            <div class="modal-header">
                <h3>欢迎使用 学习助手</h3>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                
                <!-- ****** 修改开始：调换顺序 ****** -->

                <h4>📜 用户使用协议</h4>
                <p>在您使用本应用前，请仔细阅读并同意以下条款：</p>
                <ol>
                    <li><strong>数据存储与隐私</strong>：本应用的所有数据，包括您创建的题库和学习记录，均存储在您当前使用的浏览器本地存储（IndexedDB或LocalStorage）中。我们作为开发者，不会也无法访问、收集或上传您的任何个人数据。您的数据安全和隐私由您自己掌控。</li>
                    <li><strong>数据丢失风险</strong>：由于数据存储在本地，当您清除浏览器缓存、更换浏览器或设备时，数据将会丢失。强烈建议您定期使用"管理"面板中的"备份数据"功能，将数据导出到您的本地电脑，以防意外丢失。</li>
                    <li><strong>API 使用</strong>：本应用的AI相关功能（如AI助手、AI对决）依赖于第三方API服务（如DeepSeek）。这些服务可能产生调用成本，并且有使用限制。我们已为演示设置了合理的体验额度，但不对其服务的持续性、稳定性或响应内容的准确性做任何保证。</li>
                    <li><strong>内容责任</strong>：您通过本应用创建、导入或生成的任何内容，其责任由您自行承担。请确保内容合法合规。</li>
                    <li><strong>免责声明</strong>：本应用是一个学习辅助工具，我们尽力确保其功能的稳定性，但不对因使用本应用可能导致的任何直接或间接损失（包括数据丢失）负责。</li>
                </ol>
                <p>点击"同意并开始使用"即表示您已阅读、理解并同意上述所有条款。</p>

                <hr style="margin: 20px 0;">

                <h4>📝 使用介绍</h4>
                <p>本应用是一个本地化的学习工具，旨在帮助您进行艺术史与世界常识的学习和自测。主要功能包括：</p>
                <ul>
                    <li><strong>题库学习</strong>：通过卡片式界面浏览和进行不同章节的测验。</li>
                    <li><strong>AI 助手</strong>：点击右侧侧边栏的 🧠 按钮，随时与AI进行学情诊断、题目解析等互动。</li>
                    <li><strong>错题回顾</strong>：所有答错的题目会自动收录到错题本，方便您集中复习。</li>
                    <li><strong>学习统计</strong>：以图表和数据的形式，直观地展示您的学习进度和成果。</li>
                    <li><strong>数据管理</strong>：您的所有数据（题库、进度）都保存在您自己的浏览器本地，我们不收集任何个人数据。您可以在管理面板中随时备份和恢复。</li>
                </ul>
                
                <!-- ****** 修改结束 ****** -->

            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="action-btn primary" id="agreeAndStartBtn" style="padding: 12px 24px; font-size: 1em;">✅ 同意并开始使用</button>
            </div>
        </div>
    </div>

    <!-- 脚本引入顺序很重要 -->
    <!-- 核心配置和工具类 -->
    <script src="js/config.js"></script>
    <script src="js/data-definitions.js"></script>
    <script src="js/achievement-definitions.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/markdown-renderer.js"></script>
    
    <!-- storage-manager 应该在 data-manager 和 progress-manager 使用它之前 -->
    <script src="js/storage-manager.js"></script>
    <script src="js/api-metrics-manager.js"></script>

    <!-- AI 相关基础类 -->
    <script src="js/deepseekApiClient.js"></script>
    <script src="js/diagnosticStorage.js"></script>

    <!-- 核心功能模块 (按大致依赖顺序) -->
    <!-- data-manager 依赖 config-* 文件 -->
    <script src="js/data-manager.js"></script>
    <!-- progress-manager 依赖 data-manager 和 storage-manager -->
    <script src="js/progress-manager.js"></script>
    <!-- quiz-engine 依赖 data-manager, progress-manager, AppConfig -->
    <script src="js/quiz-engine.js"></script>
    <!-- review-manager 依赖 progress-manager -->
    <script src="js/review-manager.js"></script>
    <!-- statistics-manager 依赖 progress-manager, data-manager -->
    <script src="js/statistics-manager.js"></script>
    <!-- admin-manager 依赖 data-manager, storage-manager -->
    <script src="js/admin-manager.js"></script>
    <!-- ai-duel-manager 依赖 AppConfig -->
    <script src="js/ai-duel-manager.js"></script>
    <!-- aiChatManager 依赖 deepseekApiClient, AppConfig -->
    <script src="js/aiChatManager.js"></script>
    
    <!-- UI和应用主逻辑 (最后加载) -->
    <script src="js/ui-manager.js"></script>
    <script src="js/app.js"></script>
    <!-- 加载失败时的备用提示 (这个可以保留在最后) -->
    <script>
        // 如果3秒后应用还没有初始化完成，显示提示
        setTimeout(() => {
            if (!window.app || !window.app.initialized) {
                console.warn('应用初始化可能遇到问题');
                
                // 检查关键依赖
                const missingDeps = [];
                if (!window.storageManager) missingDeps.push('存储管理器');
                if (!window.AppConfig) missingDeps.push('配置文件');
                if (!window.dataManager) missingDeps.push('数据管理器');
                if (!window.progressManager) missingDeps.push('进度管理器');
                if (!window.quizEngine) missingDeps.push('题库引擎');
                if (!window.reviewManager) missingDeps.push('错题回顾管理器');
                if (!window.statisticsManager) missingDeps.push('统计管理器');
                if (!window.adminManager) missingDeps.push('管理面板');
                if (!window.uiManager) missingDeps.push('界面管理器');
                if (!window.aiChatManager) missingDeps.push('AI聊天管理器');
                
                if (missingDeps.length > 0) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `
                        position: fixed; 
                        top: 10px; 
                        right: 10px; 
                        background: #ffeb3b; 
                        color: #333; 
                        padding: 15px; 
                        border-radius: 8px; 
                        font-family: sans-serif; 
                        font-size: 14px; 
                        z-index: 10000;
                        max-width: 300px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    `;
                    errorDiv.innerHTML = `
                        <strong>⚠️ 加载提示</strong><br>
                        以下模块可能未正确加载：<br>
                        ${missingDeps.map(dep => `• ${dep}`).join('<br>')}
                        <br><br>
                        <small>请检查文件路径或刷新页面重试</small>
                    `;
                    document.body.appendChild(errorDiv);
                    
                    // 5秒后自动隐藏提示
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }, 3000);
    </script>
    <!-- AI Duel Subject Select Modal (这个HTML结构，不是JS，可以保留在body底部) -->
    <div class="modal-overlay" id="aiDuelSubjectModal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>选择AI对决科目</h3>
                <button class="modal-close" id="closeAiDuelSubjectModal">×</button>
            </div>
            <div class="modal-body">
                <p>请选择一个大科目进行AI对决：</p>
                <select id="aiDuelSubjectSelect" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc;">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="modal-footer">
                <button class="ai-btn secondary" id="cancelAiDuelSubject">取消</button>
                <button class="ai-btn primary" id="confirmAiDuelSubject">开始对决</button>
            </div>
        </div>
    </div>
</body>
</html>